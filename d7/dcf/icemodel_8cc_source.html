<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="generator" content="Doxygen 1.8.11"/>
    <title>ANITA Software: components/icemc/icemodel.cc Source File</title>
    <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="../../jquery.js"></script>
    <script type="text/javascript" src="../../dynsections.js"></script>
    <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
    <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
    <link href="../../customdoxygen.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
	<table cellspacing="0" cellpadding="0">
	  <tbody>	    
	    <tr style="height: 56px;">
	      <td id="projectlogo"><img width="960" alt="Logo" src="../../anitaSoftware.png"/></td>
	    </tr>
	  </tbody>
	</table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Introduction</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_409f97388efe006bc3438b95e9edef48.html">components</a></li><li class="navelem"><a class="el" href="../../dir_de1961011fa38df2c6d5e9e49bef1e29.html">icemc</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">icemodel.cc</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &quot;vector.hh&quot;</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &quot;TH1.h&quot;</span> </div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#include &quot;TFile.h&quot;</span> </div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#include &quot;TChain.h&quot;</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &quot;Constants.h&quot;</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &quot;Settings.h&quot;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &quot;earthmodel.hh&quot;</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &quot;icemodel.hh&quot;</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;assert.h&gt;</span> </div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;signal.hh&quot;</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;position.hh&quot;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;Primaries.h&quot;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;anita.hh&quot;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;ray.hh&quot;</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;balloon.hh&quot;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;Settings.h&quot;</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;EnvironmentVariable.h&quot;</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;icemc_random.h&quot;</span> </div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">using</span> std::endl;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">using</span> std::cout;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">using</span> std::string;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">using</span> std::ifstream;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">using</span> std::cerr;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">const</span> <span class="keywordtype">string</span> ICEMC_SRC_DIR = <a class="code" href="../../d4/d7f/namespace_environment_variable.html#a064f876067320b15e34beb8c29c8ffdc">EnvironmentVariable::ICEMC_SRC_DIR</a>();</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">const</span> <span class="keywordtype">string</span> ICEMC_DATA_DIR = ICEMC_SRC_DIR+<span class="stringliteral">&quot;/data/&quot;</span>;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  </div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#ifdef ICEMODEL_DEBUG_TREE</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;ClassImp(<a class="code" href="../../d8/d3a/structicemodel__debug.html">icemodel_debug</a>); </div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;TTree.h&quot;</span> </div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">static</span> TFile * debugfile = 0; </div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="keyword">static</span> TTree * debugtree = 0; </div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d8/d3a/structicemodel__debug.html">icemodel_debug</a> * dbg = <span class="keyword">new</span> <a class="code" href="../../d8/d3a/structicemodel__debug.html">icemodel_debug</a>; </div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> write_the_tree() </div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;{</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  <span class="keywordflow">if</span> (debugtree)</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  {</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    debugfile-&gt;cd(); </div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    debugtree-&gt;Write(); </div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="keyword">delete</span> debugfile ;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  }</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;}</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> setupTree() </div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;{</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <span class="keywordflow">if</span> (!debugtree) </div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  {</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    debugfile = <span class="keyword">new</span> TFile(Form(<span class="stringliteral">&quot;icemodel_debug_%d.root&quot;</span>,getpid()),<span class="stringliteral">&quot;RECREATE&quot;</span>); </div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    debugtree = <span class="keyword">new</span> TTree(<span class="stringliteral">&quot;debug&quot;</span>,<span class="stringliteral">&quot;debug&quot;</span>); </div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    debugtree-&gt;Branch(<span class="stringliteral">&quot;dbg&quot;</span>,dbg); </div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    atexit(write_the_tree); </div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  }</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;}</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keyword">class </span>FillTreeOnReturn</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;{</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <span class="keyword">public</span>: </div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    FillTreeOnReturn(TFile * cdto, TTree * tree)  : f(cdto), t(tree) { ; } </div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    ~FillTreeOnReturn() {</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;      TDirectory * tmp = gDirectory; </div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;      f-&gt;cd(); </div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;      t-&gt;Fill();</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      tmp-&gt;cd(); </div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    } </div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="keyword">private</span>: </div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    TFile * f; </div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    TTree * t; </div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;};</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> inHistBounds(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keyword">const</span> TH2 &amp; h)</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;{</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keywordflow">if</span> (x &lt; h.GetXaxis()-&gt;GetXmin()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="keywordflow">if</span> (y &lt; h.GetYaxis()-&gt;GetXmin()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <span class="keywordflow">if</span> (x &gt; h.GetXaxis()-&gt;GetXmax()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="keywordflow">if</span> (y &gt; h.GetYaxis()-&gt;GetXmax()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>; </div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;}</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;IceModel::IceModel(<span class="keywordtype">int</span> model,<span class="keywordtype">int</span> earth_model,<span class="keywordtype">int</span> WEIGHTABSORPTION_SETTING) : <a class="code" href="../../d1/d3b/class_earth_model.html">EarthModel</a>(earth_model,WEIGHTABSORPTION_SETTING) </div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;{</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    </div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    bedmap_R = scale_factor*bedmap_c_0 * pow(( (1 + eccentricity*sin(71*RADDEG)) / (1 - eccentricity*sin(71*RADDEG)) ),eccentricity/2) * tan((PI/4) - (71*RADDEG)/2); <span class="comment">//varies with latitude, defined here for 71 deg S latitude</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    bedmap_nu = bedmap_R / cos(71*RADDEG);</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    </div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="comment">//Parameters of the BEDMAP ice model. (See http://www.antarctica.ac.uk/aedc/bedmap/download/)</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    nCols_ice=1200; <span class="comment">//number of columns in data, set by header file (should be 1200)</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    nRows_ice=1000; <span class="comment">//number of rows in data, set by header file (should be 1000)</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    cellSize=5000; <span class="comment">//in meters, set by header file (should be 5000) - same for both files</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    xLowerLeft_ice=-3000000; </div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    yLowerLeft_ice=-2500000;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    nCols_ground=1068;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    nRows_ground=869;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    xLowerLeft_ground=-2661600;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    yLowerLeft_ground=-2149967;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    nCols_water=1200;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    nRows_water=1000;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    xLowerLeft_water=-3000000;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    yLowerLeft_water=-2500000;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    NODATA=-9999;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    </div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    h_ice_thickness.SetTitle(<span class="stringliteral">&quot;BEDMAP Ice Thickness; Easting (m), Northing (m)&quot;</span>); </div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    h_ground_elevation.SetTitle(<span class="stringliteral">&quot;BEDMAP Ground Elevation; Easting (m), Northing (m)&quot;</span>); </div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    h_water_depth.SetTitle(<span class="stringliteral">&quot;BEDMAP Water Depth; Easting (m), Northing (m)&quot;</span>); </div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    </div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    sample_x = 0; </div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    sample_y = 0; </div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    </div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    ice_model=model;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    DEPTH_DEPENDENT_N = (int) (model / 10);</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    ice_model -= DEPTH_DEPENDENT_N * 10;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    </div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    </div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="keywordflow">if</span> (ice_model != 0 &amp;&amp; ice_model != 1) {</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    cout&lt;&lt;<span class="stringliteral">&quot;Error!  Unknown ice model requested!  Defaulting to Crust 2.0.\n&quot;</span>;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    ice_model = 0;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ice_model==1) {</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    ReadIceThickness();</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    ReadWaterDepth();</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    ReadGroundBed();</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    } <span class="comment">//else if (BEDMAP)</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="comment">//read in attenuation length data for direct signals</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keywordtype">int</span> i=0;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    </div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    ifstream sheetup((ICEMC_DATA_DIR+<span class="stringliteral">&quot;/icesheet_attenlength_up.txt&quot;</span>).c_str());</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="keywordflow">if</span>(sheetup.fail())</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    {</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    cerr &lt;&lt; <span class="stringliteral">&quot;Failed to open icesheet_attenlength_up.txt&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    exit(1);</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    }</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    </div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    i=0;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keywordflow">while</span>(sheetup&gt;&gt;d_sheetup[i]&gt;&gt;l_sheetup[i])</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    {</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    i++;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    }</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    sheetup.close();</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    </div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    ifstream shelfup((ICEMC_DATA_DIR+<span class="stringliteral">&quot;/iceshelf_attenlength_up.txt&quot;</span>).c_str());</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keywordflow">if</span>(shelfup.fail())</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    {</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    cerr &lt;&lt; <span class="stringliteral">&quot;Failed to open iceshelf_attenlength_up.txt&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    exit(1);</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    }</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    </div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    i=0;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="keywordflow">while</span>(shelfup&gt;&gt;d_shelfup[i]&gt;&gt;l_shelfup[i])</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    {</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    i++;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    }</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    shelfup.close();</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    </div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    ifstream westlandup((ICEMC_DATA_DIR+<span class="stringliteral">&quot;/westland_attenlength_up.txt&quot;</span>).c_str());</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    </div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keywordflow">if</span>(westlandup.fail())</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    {cerr &lt;&lt; <span class="stringliteral">&quot;Failed to open westland_attenlength_up.txt&quot;</span>;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    exit(1);</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    }</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    i=0;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keywordflow">while</span>(westlandup&gt;&gt;d_westlandup[i]&gt;&gt;l_westlandup[i])</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    {</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    i++;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    }</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    westlandup.close();</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    </div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="comment">//read in attenuation length for downgoing signals</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    ifstream sheetdown((ICEMC_DATA_DIR+<span class="stringliteral">&quot;/icesheet_attenlength_down.txt&quot;</span>).c_str());</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordflow">if</span>(sheetdown.fail())</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    {</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    cerr &lt;&lt; <span class="stringliteral">&quot;Failed to open icesheet_attenlength_down.txt&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    exit(1);</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    }</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    </div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    i=0;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordflow">while</span>(sheetdown&gt;&gt;d_sheetdown[i]&gt;&gt;l_sheetdown[i])</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    {</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    i++;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    }</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    sheetdown.close();</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    </div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    ifstream shelfdown((ICEMC_DATA_DIR+<span class="stringliteral">&quot;/iceshelf_attenlength_down.txt&quot;</span>).c_str());</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keywordflow">if</span>(shelfdown.fail())</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    {</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    cerr &lt;&lt; <span class="stringliteral">&quot;Failed to open iceshelf_attenlength_down.txt&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    exit(1);</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    }</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    </div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    i=0;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="keywordflow">while</span>(shelfdown&gt;&gt;d_shelfdown[i]&gt;&gt;l_shelfdown[i])</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    {</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    i++;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    }</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    shelfdown.close();</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    </div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    ifstream westlanddown((ICEMC_DATA_DIR+<span class="stringliteral">&quot;/westland_attenlength_down.txt&quot;</span>).c_str());</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="keywordflow">if</span>(westlanddown.fail())</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    {cerr &lt;&lt; <span class="stringliteral">&quot;Failed to open westland_attenlength_down.txt&quot;</span>;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    exit(1);</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    }</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    i=0;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordflow">while</span>(westlanddown&gt;&gt;d_westlanddown[i]&gt;&gt;l_westlanddown[i])</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    {</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    i++;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    }</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    westlanddown.close();</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    cart_ice_top = 0; </div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    cart_ice_bot = 0; </div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    cart_ice_file = 0; </div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    cart_resolution = 0; </div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    cart_min_z = -1; </div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    cart_max_z = -1; </div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;}</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">//constructor IceModel(int model)</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;IceModel::~IceModel() </div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;{</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="keywordflow">if</span> (cart_ice_top) <span class="keyword">delete</span> cart_ice_top; </div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  <span class="keywordflow">if</span> (cart_ice_bot) <span class="keyword">delete</span> cart_ice_bot; </div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  <span class="keywordflow">if</span> (cart_ice_file) <span class="keyword">delete</span> cart_ice_file; </div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;}</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<a class="code" href="../../d7/d3b/class_position.html">Position</a> IceModel::PickBalloonPosition() {</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <a class="code" href="../../d5/db2/class_vector.html">Vector</a> temp;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="keywordflow">return</span> temp;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    </div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;}</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<a class="code" href="../../d7/d3b/class_position.html">Position</a> IceModel::PickInteractionLocation(<span class="keywordtype">int</span> ibnposition, <a class="code" href="../../db/d2b/class_settings.html">Settings</a> *settings1, <span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;rbn, <a class="code" href="../../d3/d8e/class_interaction.html">Interaction</a> *interaction1) {</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    </div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="comment">// random numbers used</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="keywordtype">double</span> rnd1=0;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordtype">double</span> rnd3=1.;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    </div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keywordtype">double</span> vol_bybin=0.; <span class="comment">// volume of ice in each bin</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keywordtype">int</span> whichbin_forcrust20=0; <span class="comment">// choice of a bin of ice for the interaction to occur in, for Crust 2.0</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="keywordtype">int</span> which_coord=0;<span class="comment">// choice of coordinates for the interaction, for Bedmap</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="keywordtype">double</span> phi=0,theta=0; <span class="comment">// phi and theta for interaction location</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="keywordtype">double</span> lon=0,lat=0; <span class="comment">// longitude and latitude corresponding to those phi and theta</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keywordtype">int</span> ilat=0,ilon=0; <span class="comment">// ilat and ilon bins where interaction occurs</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="keywordtype">int</span> e_coord=0; <span class="comment">//east coordinate of interaction, from Bedmap</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="keywordtype">int</span> n_coord=0; <span class="comment">// north coordinate of interaction, from Bedmap</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    </div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    TRandom * rng = getRNG(RNG_INTERACTION_LOCATION); </div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    </div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    (void) settings1; </div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    (void) rbn; </div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    (void) interaction1; </div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    </div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="comment">//in case of roughness, create an array of allowable indices for the lookup (so this stay local to this function and we don&#39;t modify *horizon[ibnposition] and fark up other things downstream)</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="comment">/*if(settings1-&gt;ROUGHNESS){</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">      interaction1-&gt;noway=0;</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">      interaction1-&gt;wheredoesitleave_err=0;</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">      interaction1-&gt;neverseesice=0;</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">      interaction1-&gt;wheredoesitenterice_err=0;</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">      interaction1-&gt;toohigh=0;</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">      interaction1-&gt;toolow=0;</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">      bool bl_foundit = false;</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">      Position temppos;</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">      while (!bl_foundit){</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment">        // go through selecting a shift off the balloon position to get lon,lat</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">        Vector blnormal = GetSurfaceNormal(rbn).Unit();</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">        Vector unitx = Vector();</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">        Vector unity;</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">        unitx = unitx - unitx.Dot(blnormal)*blnormal;</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">        unity = blnormal.Cross(unitx);</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">        temppos = rbn + rng-&gt;Rndm() * settings1-&gt;ROUGH_INTPOS_SHIFT * unitx + rng-&gt;Rndm() * settings1-&gt;ROUGH_INTPOS_SHIFT * unity;</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment">        lon = temppos.Lon();</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">        lat = temppos.Lat();</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">        //if( !IceThickness(lon,lat)){   //ignore if not thick enough</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">        //  continue;                       // PickPosnuForaLonLat below complained too much</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">        //}</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment">        bl_foundit = true;</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="comment">      }</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="comment">      theta = lat*RADDEG;</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment">      phi=LongtoPhi_0is180thMeridian(lon); // convert longitude to phi</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">      //cout &lt;&lt; rbn.Lon() &lt;&lt; &quot;  &quot;&lt;&lt; rbn.Lat() &lt;&lt; &quot;  &quot; &lt;&lt;temppos.Lon()&lt;&lt; &quot;  &quot;&lt;&lt;temppos.Lat()&lt;&lt; &quot;  :: &quot;;</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">    }</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">    else{ // NO roughness case*/</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;      <span class="comment">//cout &lt;&lt; &quot;in pickinteractionlocation, size of ilat_inhorizon is &quot; &lt;&lt; ilat_inhorizon[ibnposition].size() &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;      <span class="keywordflow">if</span> (ice_model == 0) { <span class="comment">// this is Crust 2.0</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;Inside Crust 2.0 if statement.\n&quot;;</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        <span class="comment">// vol_bybin is initialized to 0</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="keywordflow">while</span>(vol_bybin/maxvol_inhorizon[ibnposition]&lt;rnd3) {</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;          rnd3=rng-&gt;Rndm(); <span class="comment">// pick random numbers between 0 and 1</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;          rnd1=rng-&gt;Rndm();</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;      </div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;          whichbin_forcrust20=(int)(rnd1*(<span class="keywordtype">double</span>)ilat_inhorizon[ibnposition].size());</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;          ilat=ilat_inhorizon[ibnposition][whichbin_forcrust20];</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;          ilon=ilon_inhorizon[ibnposition][whichbin_forcrust20];</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;          vol_bybin=icethkarray[ilon][ilat]*1000.*area[ilat];</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        } <span class="comment">//while</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        phi=SmearPhi(ilon, rng-&gt;Rndm());</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        theta=SmearTheta(ilat, rng-&gt;Rndm());</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        lon = GetLon(phi);</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        lat = GetLat(theta);</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="comment">//        cout &lt;&lt; &quot;ibnposition, phi, theta, lon, lat are &quot; &lt;&lt; ibnposition &lt;&lt; &quot; &quot; &lt;&lt; phi &lt;&lt; &quot; &quot; &lt;&lt; theta &lt;&lt; &quot; &quot; &lt;&lt; lon &lt;&lt; &quot; &quot; &lt;&lt; lat &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;      } <span class="comment">//end if(Crust 2.0)</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ice_model==1) { <span class="comment">// this is Bedmap</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;Inside Bedmap if statement.\n&quot;;</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        <span class="keywordflow">while</span>(vol_bybin/maxvol_inhorizon[ibnposition]&lt;rnd3) {</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;          rnd3=rng-&gt;Rndm();</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;          rnd1=rng-&gt;Rndm();</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;          which_coord=(int)(rnd1*(<span class="keywordtype">double</span>)easting_inhorizon[ibnposition].size());</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;          e_coord=easting_inhorizon[ibnposition][which_coord];</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;          n_coord=northing_inhorizon[ibnposition][which_coord];</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;          <span class="comment">//      cout &lt;&lt; &quot;e_coord, n_coord are &quot; &lt;&lt; e_coord &lt;&lt; &quot; &quot; &lt;&lt; n_coord &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;          GroundENtoLonLat(e_coord,n_coord,lon,lat); <span class="comment">//Recall that the e / n coordinates in horizon were picked from the ground bed array.</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;          <span class="comment">//lon+=180.;</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;          <span class="comment">//cout &lt;&lt; &quot;lon, lat are &quot; &lt;&lt; lon &lt;&lt; &quot; &quot; &lt;&lt; lat &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;          <span class="keywordflow">if</span> (e_coord &gt; 1068 || e_coord &lt; 0 || n_coord &lt; 0 || n_coord &gt; 869)</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;          cout&lt;&lt;<span class="stringliteral">&quot;Problem in PickDownward: e_coord, n_coord : &quot;</span>&lt;&lt;e_coord&lt;&lt;<span class="stringliteral">&quot; , &quot;</span>&lt;&lt;n_coord&lt;&lt;endl;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;          vol_bybin=IceThickness(lon,lat)*Area(lat);</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        } <span class="comment">//while</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        theta = lat*RADDEG;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        phi=LongtoPhi_0is180thMeridian(lon); <span class="comment">// convert longitude to phi</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;      } <span class="comment">//end if(BEDMAP)</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="comment">//}</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <span class="comment">//all routines (roughness or no) \it{should} deliver a lon, lat, theta, phi</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="comment">//roughness may not sometimes, should add checks or something</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <a class="code" href="../../d5/db2/class_vector.html">Vector</a> posnu=PickPosnuForaLonLat(lon,lat,theta,phi);</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="comment">//Vector blnormal = GetSurfaceNormal(rbn).Unit();</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="comment">//cout &lt;&lt; blnormal.Angle(Vector(rbn[0]-posnu[0],rbn[1]-posnu[1],rbn[2]-posnu[2]))*180./PI&lt;&lt;&quot;\n&quot;;</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="keywordflow">return</span> posnu;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;} <span class="comment">//PickInteractionLocation</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> inu = 0; </div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="keyword">const</span> <span class="keywordtype">int</span> PICK_RANDOM_SEGMENT = 1; </div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> sampleLocation( <span class="keywordtype">double</span> len_int_kgm2, </div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                           std::vector&lt;std::pair&lt;double,double&gt; &gt; &amp; ice_intersections, </div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                           <a class="code" href="../../d3/d8e/class_interaction.html">Interaction</a> *  interaction1, <span class="keyword">const</span> <a class="code" href="../../d5/db2/class_vector.html">Vector</a> &amp; x,  TRandom * rng, <a class="code" href="../../de/d63/class_ice_model.html">IceModel</a> * model ) </div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;{</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  <span class="comment">//bah, this is dumb. But we don&#39;t want to have to call Getchord twice for the segments. </span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    std::vector&lt;double&gt; interaction_weights(ice_intersections.size()); </div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    std::vector&lt;double&gt; absorption_weights(ice_intersections.size()); </div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordtype">double</span> cumulative_prob = 0; </div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    std::vector&lt;double&gt; lengths(ice_intersections.size()); </div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    std::vector&lt;double&gt; cumulative_probs(ice_intersections.size()); </div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    std::vector&lt;double&gt; chords(ice_intersections.size()); </div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    std::vector&lt;double&gt; nearthlayers(ice_intersections.size()); </div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    std::vector&lt;double&gt; total_kgm2(ice_intersections.size()); </div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    std::vector&lt;int&gt; crust_entered(ice_intersections.size()); </div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    std::vector&lt;int&gt; mantle_entered(ice_intersections.size()); </div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    std::vector&lt;int&gt; core_entered(ice_intersections.size()); </div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    std::vector&lt;Vector&gt; enterices; </div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    std::vector&lt;Vector&gt; exitices; </div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="comment">//we need a point on the trajectory for this (doesn&#39;t have to be the final location!) Use halfway within the first ice intersection as trial point. </span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;   </div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8e3ba9835075f10bf3b1aa136a828434">r_in</a> = model-&gt;WhereDoesItEnter(x + 0.5 * (ice_intersections[0].second + ice_intersections[0].first) * interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a>,  interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a>);</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;      <span class="keywordtype">double</span> L_ice=len_int_kgm2/Signal::RHOICE;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    interaction1-&gt;pathlength_inice = 0;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="comment">// we need to find the relative probability of having an interaction in each ice segment. </span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="comment">// use the probability of interacting in the ice segment (interaction weight) multiplied by the probability of not having absorbed prior to do this </span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="comment">// since these are calculated by Getchord, call Getchord once for each ice segment, using the ice entrance point. </span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="comment">// Save all the values so that they can be set when the ice interaction point is selected. </span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; ice_intersections.size(); i++) </div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    {</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;      <span class="keywordtype">double</span> this_length = ice_intersections[i].second - ice_intersections[i].first; </div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;      lengths[i] = this_length; </div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;      <span class="comment">//get absorption weight to enter point</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;      enterices.push_back(x +  ice_intersections[i].first * interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a>);</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;      exitices.push_back( x +  ice_intersections[i].second * interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a>);</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160; </div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  </div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;      model-&gt;Getchord(<span class="keyword">true</span>, </div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                      len_int_kgm2, </div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                      interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8e3ba9835075f10bf3b1aa136a828434">r_in</a>, </div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                      this_length, <span class="keyword">true</span>, <span class="comment">//include absorption from OTHER ice. This ice shouldn&#39;t be included since using entrance point</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                      enterices[i], </div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                      inu, <span class="comment">//may not be perfecly synchronized... for debug only </span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                      chords[i], </div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                      interaction_weights[i], </div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                      absorption_weights[i], </div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                      nearthlayers[i], </div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                      0, <span class="comment">//TODO myair, not supported for point sources right now</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                      total_kgm2[i], crust_entered[i], mantle_entered[i], core_entered[i]); </div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;      interaction1-&gt;pathlength_inice += this_length;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;      cumulative_prob += interaction_weights[i]; </div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      cumulative_probs[i] = cumulative_prob; </div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    }</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    <span class="keywordtype">int</span> which = -1; </div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">if</span> (PICK_RANDOM_SEGMENT)</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    {</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;      which = rng-&gt;Integer(ice_intersections.size()); </div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    }</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    <span class="keywordflow">else</span> </div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    {</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      <span class="comment">//now select the ice we interact in </span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;      <span class="keywordtype">double</span> p = rng-&gt;Uniform(0, cumulative_prob); </div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;      which = std::upper_bound(cumulative_probs.begin(), cumulative_probs.end(), p) - cumulative_probs.begin(); </div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    }</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8d6ead334dc4c35bfd23a25237e212af">r_enterice</a> = enterices[which]; </div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8d9fcec0d43f38c83f692ed19026fed8">nuexitice</a> = exitices[which]; </div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a46d7e538970790ac8d4eff1f9024af93">total_kgm2</a> = total_kgm2[which];</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    interaction1-&gt;nearthlayers = nearthlayers[which];</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    interaction1-&gt;crust_entered = crust_entered[which];</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    interaction1-&gt;mantle_entered = mantle_entered[which];</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    interaction1-&gt;core_entered = core_entered[which];</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a3ef3decda6e004ad20f541949a948ae0">weight_nu</a> = absorption_weights[which];</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <span class="keywordflow">if</span> (PICK_RANDOM_SEGMENT ) </div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    {</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#abcc316da4319289b2c4517df75c002e4">weight_nu_prob</a> = interaction_weights[which] * ice_intersections.size(); </div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    }</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    {</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;      interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#abcc316da4319289b2c4517df75c002e4">weight_nu_prob</a> = cumulative_prob;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    }</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    </div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="comment">//let&#39;s exponentially attenuate within the ice (ignoring any gaps in ice... those will be covered in principle by the attenuation weight)</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordtype">double</span> this_length = lengths[which]; </div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keywordtype">double</span> distance = 0; </div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="comment">//If we have a very short path length in ice, it&#39;s ok to just assume it&#39;s uniform</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <span class="keywordflow">if</span> (this_length/ L_ice &lt; 1e-3) </div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    {</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;       distance = rng-&gt;Rndm() * this_length; </div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    }</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    {</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;       distance = -log(rng-&gt;Uniform(exp(-this_length/L_ice),1))*L_ice; </div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    }</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    </div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="comment">//finally assign the position</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;   interaction1-&gt;posnu = enterices[which] + distance * interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a>; </div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;   inu++; </div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="preprocessor">#ifdef ICEMODEL_DEBUG_TREE</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;   dbg-&gt;sum_weight_probs = cumulative_prob; </div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; enterices.size(); i++) </div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;   {</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;     dbg-&gt;abs_weights.push_back(absorption_weights[i]); </div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;     dbg-&gt;weight_probs.push_back(interaction_weights[i]); </div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;     dbg-&gt;lengths.push_back(lengths[i]); </div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;   }</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;}</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="keywordtype">int</span> IceModel::PickUnbiasedPointSourceNearBalloon(<a class="code" href="../../d3/d8e/class_interaction.html">Interaction</a> * interaction1, <span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> * balloon_position, </div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                                      <span class="keywordtype">double</span> maxdist, <span class="keywordtype">double</span> chord_step,  <span class="keywordtype">double</span> len_int_kgm2, <span class="keyword">const</span> <a class="code" href="../../d5/db2/class_vector.html">Vector</a> * force_dir) </div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;{</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="preprocessor">#ifdef ICEMODEL_DEBUG_TREE</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    setupTree(); </div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    dbg-&gt;reset() ; </div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    FillTreeOnReturn fill (debugfile, debugtree); </div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="comment">// first pick the neutrino direction</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <span class="keywordflow">if</span> (!force_dir) </div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    {</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;      interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a360281505aa31a40d78a09d7c7b70000">PickAnyDirection</a>();</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    }</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    {</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;      interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a> = *force_dir; </div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    }</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    </div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    TRandom * rng = getRNG(RNG_INTERACTION_LOCATION); </div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    <span class="comment">//now we pick a point in the plane normal to the neutrino direction</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="comment">// We will use the point directly below ANITA with an altitude at 0 km as a reference then consider offsets</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="comment">// relative to that in that plane. </span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    </div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="comment">//piece of shit! </span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> ref(balloon_position-&gt;<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>()+180, balloon_position-&gt;<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>(), R_EARTH); </div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="comment">// For now, randomly pick an offset up to maxdist km away </span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="comment">// This can be optimized by precalculating the polygon </span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="comment">// visible from this angle or finding the bounds in some other way... </span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="comment">// Especially for nearly orthogonal events this will be far too big... </span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keywordtype">double</span> x= rng-&gt;Uniform(-maxdist*1e3,maxdist*1e3); </div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="keywordtype">double</span> y= rng-&gt;Uniform(-maxdist*1e3,maxdist*1e3); </div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    sample_x =x; sample_y = y; </div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;     </div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="comment">// get nnu as a TVector3 since I like those better</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <a class="code" href="../../d5/db2/class_vector.html">Vector</a> nudir = interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a>.Unit(); <span class="comment">//is probably already a unit vector? </span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <a class="code" href="../../d5/db2/class_vector.html">Vector</a> orth = nudir.Orthogonal(); </div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <a class="code" href="../../d5/db2/class_vector.html">Vector</a> orth2 = nudir.Cross(orth);</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    <a class="code" href="../../d5/db2/class_vector.html">Vector</a> p0 = ref + x*orth + y*orth2; </div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="comment">//Where do we intersect the Earth? </span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> int1; </div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> int2; </div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    <span class="comment">//check if we intersect with the (super) geoid. </span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <span class="keywordtype">int</span> nintersect = GeoidIntersection(p0, nudir, &amp;int1, &amp;int2); </div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="preprocessor">#ifdef ICEMODEL_DEBUG_TREE</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    dbg-&gt;balloon.SetXYZ(balloon_position-&gt;X(), balloon_position-&gt;Y(), balloon_position-&gt;Z()); </div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    dbg-&gt;ref.SetXYZ(ref.X(), ref.Y(), ref.Z()); </div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    dbg-&gt;nudir.SetXYZ(nudir.X(), nudir.Y(), nudir.Z()); </div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    dbg-&gt;nintersect = nintersect; </div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    dbg-&gt;x = x; </div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    dbg-&gt;y = y; </div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    dbg-&gt;int1.SetXYZ(int1.X(), int1.Y(), int1.Z()); </div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    dbg-&gt;int2.SetXYZ(int2.X(), int2.Y(), int2.Z()); </div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="keywordflow">if</span> (nintersect == 0) </div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    {</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;<span class="preprocessor">#ifdef ICEMODEL_DEBUG_TREE</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;      dbg-&gt;noway = <span class="keyword">true</span>;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;      interaction1-&gt;neverseesice=1;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;      interaction1-&gt;noway = 1; </div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;      <span class="keywordflow">return</span> 0; </div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    }</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    std::vector&lt;std::pair&lt;double,double&gt; &gt; ice_intersections; </div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="keywordtype">int</span> n_intersections = GetIceIntersectionsCartesian(int1, nudir, ice_intersections,chord_step); </div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <span class="keywordflow">if</span> (n_intersections == 0) </div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    {</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="preprocessor"> #ifdef ICEMODEL_DEBUG_TREE</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;      dbg-&gt;noway = <span class="keyword">true</span>;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;      interaction1-&gt;pathlength_inice = 0;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      interaction1-&gt;neverseesice = 1;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      <span class="keywordflow">return</span> 0; </div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    }</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="comment">//    printf(&quot;Hits the ice %d times!\n&quot;, n_intersections); </span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    sampleLocation(len_int_kgm2, ice_intersections, interaction1,int1, rng, <span class="keyword">this</span>);</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="preprocessor">#ifdef ICEMODEL_DEBUG_TREE</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    dbg-&gt;exitice.SetXYZ(interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8d9fcec0d43f38c83f692ed19026fed8">nuexitice</a>.X(),interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8d9fcec0d43f38c83f692ed19026fed8">nuexitice</a>.Y(),interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8d9fcec0d43f38c83f692ed19026fed8">nuexitice</a>.Z()); </div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    dbg-&gt;enterice.SetXYZ(interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8d6ead334dc4c35bfd23a25237e212af">r_enterice</a>.X(),interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8d6ead334dc4c35bfd23a25237e212af">r_enterice</a>.Y(),interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8d6ead334dc4c35bfd23a25237e212af">r_enterice</a>.Z()); </div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    dbg-&gt;nupos.SetXYZ(interaction1-&gt;posnu.X(),interaction1-&gt;posnu.Y(),interaction1-&gt;posnu.Z()); </div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    <span class="keywordflow">if</span> (interaction1-&gt;posnu.Mag()-Surface(interaction1-&gt;posnu)&gt;0) {</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;      interaction1-&gt;toohigh=1;</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    }</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <span class="keywordflow">if</span> (interaction1-&gt;posnu.Mag()-Surface(interaction1-&gt;posnu)+IceThickness(interaction1-&gt;posnu)&lt;0) {</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;      interaction1-&gt;toolow=1;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;      <span class="keywordflow">return</span> 0; </div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    }    </div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;}</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;     </div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="keywordtype">int</span> IceModel::PickUnbiased(<a class="code" href="../../d3/d8e/class_interaction.html">Interaction</a> *interaction1, <span class="keywordtype">double</span> len_int_kgm2, <span class="keywordtype">double</span> &amp; position_weight, <span class="keywordtype">double</span> chord_step, <a class="code" href="../../d5/db2/class_vector.html">Vector</a> * force_dir) {</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    </div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    TRandom * rng = getRNG(RNG_INTERACTION_LOCATION); </div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    <span class="keywordflow">if</span> (!force_dir) </div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    {</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;      interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a360281505aa31a40d78a09d7c7b70000">PickAnyDirection</a>(); <span class="comment">// first pick the neutrino direction</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    }</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    {</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;      interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a> = *force_dir; </div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    }</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    </div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    <span class="comment">//now we pick a point somewhere on the surface of the superellipsoid. </span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="comment">//up to the coastline </span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="comment">//TODO, can pick closer to payload but hard to do while keeping ellipsoidal geometry... </span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="comment">//instead, will just reject points far away... </span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="keywordtype">double</span> sinth = rng-&gt;Uniform(0, sin(COASTLINE*RADDEG)); </div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    <span class="keywordtype">double</span> phi = rng-&gt;Uniform(0,2*TMath::Pi()); </div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    <span class="keywordtype">double</span> costh = sqrt(1-sinth*sinth); </div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">double</span> RMAX = GEOID_MAX + 5500; </div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">double</span> RMIN = GEOID_MIN + 5500; </div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    <a class="code" href="../../d5/db2/class_vector.html">Vector</a> p0(RMAX * cos(phi) * sinth, RMAX * sin(phi) * sinth, RMIN*costh); </div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    <span class="comment">// The position weight is (maybe) the dot product of the position with the neutrino direction</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    <span class="comment">// this is actually the inverse weight</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    position_weight = 1./fabs(p0.Unit() * interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a>); </div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    <span class="comment">//but actually, we can be double counting if the other superellipsoid intesrection is above coastline because</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <span class="comment">//we can sample the same trajectory twice. So let&#39;s divide position_weight by two if that is indeed the case. </span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> ints[2]; </div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    GeoidIntersection(p0, interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a>, &amp;ints[0],&amp;ints[2]); </div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="keywordtype">int</span> nabovecoastline = 0; </div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i =0; i &lt; 2; i++) </div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    {</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;      <span class="keywordflow">if</span> (ints[i].Lat() &lt; COASTLINE) nabovecoastline++; </div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    }</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    assert(nabovecoastline&gt;0); </div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    position_weight /= nabovecoastline; </div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a8d6ead334dc4c35bfd23a25237e212af">r_enterice</a> = p0; </div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    <span class="comment">//now let&#39;s set the ice intersactions</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    std::vector&lt;std::pair&lt;double,double&gt; &gt; ice_intersections; </div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <span class="keywordtype">int</span> n_intersections = GetIceIntersectionsCartesian(p0, interaction1-&gt;<a class="code" href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">nnu</a>, ice_intersections,chord_step); </div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    <span class="keywordflow">if</span> (!n_intersections)</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    {</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;      interaction1-&gt;noway = 1; </div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;      interaction1-&gt;neverseesice=1;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;      interaction1-&gt;pathlength_inice = 0;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;      <span class="keywordflow">return</span> 0; </div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    }</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    sampleLocation(len_int_kgm2, ice_intersections, interaction1,p0, rng,<span class="keyword">this</span>);</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    </div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    </div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    <span class="keywordflow">if</span> (interaction1-&gt;posnu.Mag()-Surface(interaction1-&gt;posnu)&gt;0) {</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        interaction1-&gt;toohigh=1;</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;inu, toohigh is &quot; &lt;&lt; inu &lt;&lt; &quot; &quot; &lt;&lt; interaction1-&gt;toohigh &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    }</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    <span class="keywordflow">if</span> (interaction1-&gt;posnu.Mag()-Surface(interaction1-&gt;posnu)+IceThickness(interaction1-&gt;posnu)&lt;0) {</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;      interaction1-&gt;toolow=1;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;      <span class="comment">//cout &lt;&lt; &quot;inu, toolow is &quot; &lt;&lt; inu &lt;&lt; &quot; &quot; &lt;&lt; interaction1-&gt;toolow &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    }    </div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    </div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;}</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<a class="code" href="../../d5/db2/class_vector.html">Vector</a> IceModel::GetSurfaceNormal(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;r_out) {</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    <a class="code" href="../../d5/db2/class_vector.html">Vector</a> n_surf = r_out.Unit();</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    <span class="keywordflow">if</span> (FLATSURFACE) </div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    <span class="keywordflow">return</span> n_surf;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    </div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="keywordflow">if</span> (ice_model==0) {</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    <span class="keywordtype">double</span> theta=r_out.Theta();</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    </div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="keywordtype">int</span> ilon,ilat;</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    GetILonILat(r_out,ilon,ilat);</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    </div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    <span class="keywordtype">int</span> ilon_previous=ilon-1;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <span class="keywordflow">if</span> (ilon_previous&lt;0)</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        ilon_previous=NLON-1;</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    </div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="keywordtype">int</span> ilon_next=ilon+1;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="keywordflow">if</span> (ilon_next==NLON)</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        ilon_next=0;</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    </div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    <span class="keywordtype">double</span> r=(geoid[ilat]+surfacer[ilon][ilat])*sin(theta);</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    </div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordtype">double</span> slope_phi=(surfacer[ilon_next][ilat]-surfacer[ilon_previous][ilat])/(r*2*phistep);</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    </div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <span class="keywordtype">int</span> ilat_previous=ilat-1;</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    <span class="keywordflow">if</span> (ilat_previous&lt;0)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        ilat_previous=0;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    </div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keywordtype">int</span> ilat_next=ilat+1;</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    <span class="keywordflow">if</span> (ilat_next==NLAT)</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        ilat_next=NLAT-1;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    </div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    <span class="keywordtype">double</span> slope_costheta=(surfacer[ilon][ilat_next]-surfacer[ilon][ilat_previous])/((geoid[ilat]+surfacer[ilon][ilat])*2*thetastep);</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    </div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <span class="comment">// first rotate n_surf according to tilt in costheta and position on continent - rotate around the y axis.</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    <span class="keywordtype">double</span> angle=atan(slope_costheta);</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    </div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    n_surf = n_surf.RotateY(angle);</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    </div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    <span class="comment">// now rotate n_surf according to tilt in phi - rotate around the z axis.</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    angle=atan(slope_phi);</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    </div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    n_surf = n_surf.RotateZ(angle);</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    } <span class="comment">//end if(Crust 2.0)</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ice_model==1) {</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <span class="keywordtype">double</span> dist_to_check = 7500; <span class="comment">//check elevations at this distance north, south, east and west of event</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    <span class="keywordtype">double</span> lon,lat;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    <span class="keywordtype">double</span> lon_prev,lon_next;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    <span class="keywordtype">double</span> lat_prev,lat_next;</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    lon = r_out.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>();</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    lat = r_out.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>(); <span class="comment">//longitude and latitude of interaction</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    <span class="keywordtype">double</span> local_surface_elevation = Surface(lon,lat);</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    </div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    lat_next = lat + dist_to_check * (180 / (local_surface_elevation * PI)); <span class="comment">//the latitude 7.5 km south of the interaction</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    lat_prev = lat - dist_to_check * (180 / (local_surface_elevation * PI)); <span class="comment">//the latitude 7.5 km north of the interaction</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    </div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    lon_next = lon + dist_to_check * (180 / (sin(lat*RADDEG) * local_surface_elevation * PI)); </div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    lon_prev = lon - dist_to_check * (180 / (sin(lat*RADDEG) * local_surface_elevation * PI)); </div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    </div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="keywordflow">if</span> (lat_next &gt; 90) {</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <span class="comment">//cout&lt;&lt;&quot;lat_next is &gt; 90&quot;&lt;&lt;endl;</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        lat_next = 90 - (lat_next - 90);  <span class="comment">//if we went past the pole, set coordinates for the other side</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        lon_next += 180;</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        lon_prev += 180;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    } <span class="comment">//end if</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <span class="comment">//cout&lt;&lt;&quot;lon, lat: &quot;&lt;&lt;lon&lt;&lt;&quot; , &quot;&lt;&lt;lat&lt;&lt;endl;</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    <span class="comment">//correct any out of range longitudes</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="keywordflow">if</span> (lon_next &gt; 360) {</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        <span class="comment">//cout&lt;&lt;&quot;lon_next &gt; 360\n&quot;;</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        lon_next -= 360;</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    }</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lon_next &lt; 0) {</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <span class="comment">//cout&lt;&lt;&quot;lon_next &lt; 0\n&quot;;</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        lon_next += 360;</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    }</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    <span class="keywordflow">if</span> (lon_prev &gt; 360) {</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;        <span class="comment">//cout&lt;&lt;&quot;lon_prev &gt; 360\n&quot;;</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        lon_prev -= 360;</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    }</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lon_prev &lt; 0) {</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;lon_prev &lt; 0&quot;;</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        lon_prev += 360;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    }</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    </div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    <span class="keywordtype">double</span> slope_phi=(SurfaceAboveGeoid(lon_next,lat)-SurfaceAboveGeoid(lon_prev,lat))/(2*dist_to_check);</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    </div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    <span class="keywordtype">double</span> slope_costheta=(SurfaceAboveGeoid(lon,lat_next)-SurfaceAboveGeoid(lon,lat_prev))/(2*dist_to_check);</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    </div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="comment">// first rotate n_surf according to tilt in costheta - rotate around the y axis.</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    <span class="keywordtype">double</span> angle=atan(slope_costheta);</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    </div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    n_surf = n_surf.RotateY(angle);</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    </div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    <span class="comment">// now rotate n_surf according to tilt in phi - rotate around the z axis.</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    angle=atan(slope_phi);</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    </div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    n_surf = n_surf.RotateZ(angle);</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    } <span class="comment">//end if(BEDMAP)</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    </div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    <span class="keywordflow">return</span> n_surf;</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    </div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;} <span class="comment">//method GetSurfaceNormal</span></div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="keywordtype">int</span> IceModel::WhereDoesItEnterIce(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;posnu,</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                  <span class="keyword">const</span> <a class="code" href="../../d5/db2/class_vector.html">Vector</a> &amp;nnu,</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                  <span class="keywordtype">double</span> stepsize,</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                  <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;r_enterice) {</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    <span class="comment">// now get exit point...</span></div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <span class="comment">//   see my geometry notes.</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="comment">// parameterize the neutrino trajectory and just see where it</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="comment">// crosses the earth radius.</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    </div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <span class="comment">//  Position r_enterice;</span></div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <span class="keywordtype">double</span> distance=0;</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    <span class="keywordtype">int</span> left_edge=0;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> x = posnu;</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <span class="keywordtype">double</span> x2;</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    </div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> x_previous = posnu;</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    </div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="keywordtype">double</span> x_previous2= x_previous * x_previous;</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    x2=x_previous2;</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    </div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    <span class="keywordtype">double</span> lon = x.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>(),lat = x.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>();</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="keywordtype">double</span> lon_old = lon,lat_old = lat;</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="keywordtype">double</span> local_surface = Surface(lon,lat);</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <span class="keywordtype">double</span> rock_previous2= pow((local_surface - IceThickness(lon,lat) - WaterDepth(lon,lat)),2);</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <span class="keywordtype">double</span> surface_previous2=pow(local_surface,2);</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    </div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <span class="keywordtype">double</span> rock2=rock_previous2;</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keywordtype">double</span> surface2=surface_previous2;</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="keywordtype">int</span> foundit=0;  <span class="comment">// keeps track of whether you found an ice entrance point</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    </div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="comment">//  cout &lt;&lt; &quot;lon, lat are &quot; &lt;&lt; posnu.Lon() &lt;&lt; &quot; &quot; &lt;&lt; posnu.Lat() &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;x2 at start is &quot; &lt;&lt; x2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="keywordflow">while</span> (distance&lt;2*local_surface+1000) {</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    </div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    distance+=stepsize;</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    </div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    x -= stepsize*nnu;</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    x2=x*x;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;x2 is &quot; &lt;&lt; x2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    lon = x.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>();</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    lat = x.Lat();</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    </div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    <span class="keywordtype">double</span> ice_thickness=IceThickness(lon,lat);</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    <span class="keywordflow">if</span> (lon!=lon_old || lat!=lat_old) {</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;        local_surface = Surface(lon,lat);</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;        </div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;        <span class="comment">//if (lat&gt;COASTLINE) </span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        <span class="comment">//left_edge=1;</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        </div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        rock2=pow((local_surface - IceThickness(lon,lat) - WaterDepth(lon,lat)),2);</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        surface2=pow(local_surface,2);    </div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;        </div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;        <span class="keywordflow">if</span> (ice_model==0) {</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)(lat)==COASTLINE &amp;&amp; rock_previous2 &lt; x2 &amp;&amp; surface2 &gt; x2)</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;            left_edge=1;</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        } <span class="comment">//if (Crust 2.0)</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    } <span class="comment">//if (neutrino has stepped into new lon/lat bin)</span></div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    </div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="keywordflow">if</span> ((((x_previous2&gt;rock_previous2 &amp;&amp; x2&lt;rock2) <span class="comment">// crosses rock boundary from above</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;          || (x_previous2&lt;surface_previous2 &amp;&amp; x2&gt;surface2)) &amp;&amp; ice_thickness&gt;0 &amp;&amp; lat&lt;COASTLINE) <span class="comment">// crosses surface boundary from below</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;        || left_edge) {</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;        <span class="comment">//  cout &lt;&lt; &quot;lat, COASTLINE, left_edge is &quot; &lt;&lt; lat &lt;&lt; &quot; &quot; &lt;&lt; COASTLINE&lt;&lt; &quot; &quot; &lt;&lt; left_edge &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;x_previous2, surface_previous, x2, surface2 are &quot; &lt;&lt; x_previous2 &lt;&lt; &quot; &quot; &lt;&lt; surface_previous2 &lt;&lt; &quot; &quot; &lt;&lt; x2 &lt;&lt; &quot; &quot; &lt;&lt; surface2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        r_enterice = x;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;        <span class="comment">// this gets you out of the loop.</span></div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        <span class="comment">//continue;</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;        distance=3*Geoid(lat);</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;        foundit=1;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;foundit is &quot; &lt;&lt; foundit &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;r_enterice is &quot;;r_enterice.Print();</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;        <span class="comment">//continue;</span></div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    </div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    x_previous = x;</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    x_previous2 = x2;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;x_previous, x_previous2 &quot; &lt;&lt; x &lt;&lt; &quot; &quot; &lt;&lt; x2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    </div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="keywordflow">if</span> (lon!=lon_old || lat!=lat_old) {</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        rock_previous2 = rock2;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        surface_previous2 = surface2;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        lat_old = lat;</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        lon_old = lon;</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    </div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    } <span class="comment">//while</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    </div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="keywordflow">return</span> foundit;</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;}<span class="comment">//WhereDoesItEnterIce</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;<span class="keywordtype">int</span> IceModel::WhereDoesItExitIce(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;posnu,</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                 <span class="keyword">const</span> <a class="code" href="../../d5/db2/class_vector.html">Vector</a> &amp;nnu,</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                 <span class="keywordtype">double</span> stepsize,</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                 <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;r_enterice) {</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="comment">// now get exit point...</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    <span class="comment">//   see my geometry notes.</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    <span class="comment">// parameterize the neutrino trajectory and just see where it</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    <span class="comment">// crosses the earth radius.</span></div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    </div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    <span class="comment">//  Position r_enterice;</span></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    <span class="keywordtype">double</span> distance=0;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;    <span class="keywordtype">int</span> left_edge=0;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> x = posnu;</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    <span class="keywordtype">double</span> x2;   </div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    </div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> x_previous = posnu;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    </div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <span class="keywordtype">double</span> x_previous2= x_previous * x_previous;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    x2=x_previous2;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    </div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    <span class="keywordtype">double</span> lon = x.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>(),lat = x.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>();</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="keywordtype">double</span> lon_old = lon,lat_old = lat;</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="keywordtype">double</span> local_surface = Surface(lon,lat);</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="keywordtype">double</span> rock_previous2= pow((local_surface - IceThickness(lon,lat) - WaterDepth(lon,lat)),2);</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="keywordtype">double</span> surface_previous2=pow(local_surface,2);</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    </div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    <span class="keywordtype">double</span> rock2=rock_previous2;</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    <span class="keywordtype">double</span> surface2=surface_previous2;</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    <span class="keywordtype">int</span> foundit=0;  <span class="comment">// keeps track of whether you found an ice entrance point</span></div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    </div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    </div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    </div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    <span class="comment">//  cout &lt;&lt; &quot;lon, lat are &quot; &lt;&lt; posnu.Lon() &lt;&lt; &quot; &quot; &lt;&lt; posnu.Lat() &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;x2 at start is &quot; &lt;&lt; x2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <span class="keywordtype">int</span> nsteps=0;</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    <span class="keywordflow">while</span> (distance&lt;2*local_surface+1000) {</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;another step.\n&quot;;</span></div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    distance+=stepsize;</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    nsteps++;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="comment">//    cout &lt;&lt; &quot;inu, nsteps is &quot; &lt;&lt; inu &lt;&lt; &quot; &quot; &lt;&lt; nsteps &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    x -= stepsize*nnu;</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    x2=x*x;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;x2 is &quot; &lt;&lt; x2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    lon = x.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>();</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    lat = x.Lat();</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    </div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    <span class="keywordtype">double</span> ice_thickness=IceThickness(lon,lat);</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;    <span class="keywordflow">if</span> (lon!=lon_old || lat!=lat_old) {</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        local_surface = Surface(lon,lat);</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;        </div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        <span class="comment">//if (lat&gt;COASTLINE) </span></div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;        <span class="comment">//left_edge=1;</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;        </div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        rock2=pow((local_surface - IceThickness(lon,lat) - WaterDepth(lon,lat)),2);</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        surface2=pow(local_surface,2);    </div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;        </div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        <span class="keywordflow">if</span> (ice_model==0) {</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)(lat)==COASTLINE &amp;&amp; rock_previous2 &lt; x2 &amp;&amp; surface2 &gt; x2)</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;            left_edge=1;</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        } <span class="comment">//if (Crust 2.0)</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    } <span class="comment">//if (neutrino has stepped into new lon/lat bin)</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;    </div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    <span class="keywordflow">if</span> ((((x_previous2&lt;rock_previous2 &amp;&amp; x2&gt;rock2) <span class="comment">// crosses rock boundary from above</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;          || (x_previous2&gt;surface_previous2 &amp;&amp; x2&lt;surface2)) &amp;&amp; ice_thickness&gt;0 &amp;&amp; lat&lt;COASTLINE) <span class="comment">// crosses surface boundary from above</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        || left_edge) {</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        <span class="comment">//  cout &lt;&lt; &quot;lat, COASTLINE, left_edge is &quot; &lt;&lt; lat &lt;&lt; &quot; &quot; &lt;&lt; COASTLINE&lt;&lt; &quot; &quot; &lt;&lt; left_edge &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;x_previous2, surface_previous, x2, surface2 are &quot; &lt;&lt; x_previous2 &lt;&lt; &quot; &quot; &lt;&lt; surface_previous2 &lt;&lt; &quot; &quot; &lt;&lt; x2 &lt;&lt; &quot; &quot; &lt;&lt; surface2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        r_enterice = x;</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        <span class="comment">// this gets you out of the loop.</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        <span class="comment">//continue;</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        distance=3*Geoid(lat);</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        foundit=1;</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;foundit is &quot; &lt;&lt; foundit &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        <span class="comment">//continue;</span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    </div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;    x_previous = x;</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    x_previous2 = x2;</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;x_previous, x_previous2 &quot; &lt;&lt; x &lt;&lt; &quot; &quot; &lt;&lt; x2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    </div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;    <span class="keywordflow">if</span> (lon!=lon_old || lat!=lat_old) {</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        rock_previous2 = rock2;</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        surface_previous2 = surface2;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;        lat_old = lat;</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;        lon_old = lon;</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    </div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    } <span class="comment">//while</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;    </div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    <span class="keywordflow">return</span> foundit;</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;}<span class="comment">//WhereDoesItExitIce</span></div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="keywordtype">int</span> IceModel::WhereDoesItExitIceForward(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;posnu,</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                    <span class="keyword">const</span> <a class="code" href="../../d5/db2/class_vector.html">Vector</a> &amp;nnu,</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                    <span class="keywordtype">double</span> stepsize,</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                    <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;r_enterice) {</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;    <span class="comment">// now get exit point...</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;    <span class="comment">//   see my geometry notes.</span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;    <span class="comment">// parameterize the neutrino trajectory and just see where it</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    <span class="comment">// crosses the earth radius.</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    </div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    <span class="comment">//  Position r_enterice;</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    <span class="keywordtype">double</span> distance=0;</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="keywordtype">int</span> left_edge=0;</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> x = posnu;</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    <span class="keywordtype">double</span> x2;</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    </div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> x_previous = posnu;</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    </div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="keywordtype">double</span> x_previous2= x_previous * x_previous;</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    x2=x_previous2;</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    </div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    <span class="keywordtype">double</span> lon = x.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>(),lat = x.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>();</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    <span class="keywordtype">double</span> lon_old = lon,lat_old = lat;</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    <span class="keywordtype">double</span> local_surface = Surface(lon,lat);</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    <span class="keywordtype">double</span> rock_previous2= pow((local_surface - IceThickness(lon,lat) - WaterDepth(lon,lat)),2);</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <span class="keywordtype">double</span> surface_previous2=pow(local_surface,2);</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    </div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="keywordtype">double</span> rock2=rock_previous2;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    <span class="keywordtype">double</span> surface2=surface_previous2;</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    <span class="keywordtype">int</span> foundit=0;  <span class="comment">// keeps track of whether you found an ice entrance point</span></div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;    </div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    <span class="comment">//  cout &lt;&lt; &quot;lon, lat are &quot; &lt;&lt; posnu.Lon() &lt;&lt; &quot; &quot; &lt;&lt; posnu.Lat() &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;x2 at start is &quot; &lt;&lt; x2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <span class="keywordflow">while</span> (distance&lt;2*local_surface+1000) {</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    </div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    distance+=stepsize;</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    </div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    x += stepsize*nnu;</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    x2=x*x;</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;x2 is &quot; &lt;&lt; x2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    lon = x.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>();</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    lat = x.Lat();</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    </div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    <span class="keywordtype">double</span> ice_thickness=IceThickness(lon,lat);</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;    <span class="keywordflow">if</span> (lon!=lon_old || lat!=lat_old) {</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        local_surface = Surface(lon,lat);</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;        </div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;        <span class="comment">//if (lat&gt;COASTLINE) </span></div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;        <span class="comment">//left_edge=1;</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;        </div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        rock2=pow((local_surface - IceThickness(lon,lat) - WaterDepth(lon,lat)),2);</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;        surface2=pow(local_surface,2);    </div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;        </div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;        <span class="keywordflow">if</span> (ice_model==0) {</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;        <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)(lat)==COASTLINE &amp;&amp; rock_previous2 &lt; x2 &amp;&amp; surface2 &gt; x2)</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;            left_edge=1;</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;        } <span class="comment">//if (Crust 2.0)</span></div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    } <span class="comment">//if (neutrino has stepped into new lon/lat bin)</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;    </div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    <span class="keywordflow">if</span> ((((x_previous2&lt;rock_previous2 &amp;&amp; x2&gt;rock2) <span class="comment">// enters rock boundary from above</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;          || (x_previous2&gt;surface_previous2 &amp;&amp; x2&lt;surface2)) &amp;&amp; ice_thickness&gt;0 &amp;&amp; lat&lt;COASTLINE) <span class="comment">// crosses surface boundary from below</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        || left_edge) {</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;        <span class="comment">//  cout &lt;&lt; &quot;lat, COASTLINE, left_edge is &quot; &lt;&lt; lat &lt;&lt; &quot; &quot; &lt;&lt; COASTLINE&lt;&lt; &quot; &quot; &lt;&lt; left_edge &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;x_previous2, surface_previous, x2, surface2 are &quot; &lt;&lt; x_previous2 &lt;&lt; &quot; &quot; &lt;&lt; surface_previous2 &lt;&lt; &quot; &quot; &lt;&lt; x2 &lt;&lt; &quot; &quot; &lt;&lt; surface2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;        r_enterice = x;</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;        <span class="comment">// this gets you out of the loop.</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;        <span class="comment">//continue;</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        distance=3*Geoid(lat);</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;        foundit=1;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;foundit is &quot; &lt;&lt; foundit &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;        <span class="comment">//continue;</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;    </div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    x_previous = x;</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;    x_previous2 = x2;</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;x_previous, x_previous2 &quot; &lt;&lt; x &lt;&lt; &quot; &quot; &lt;&lt; x2 &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    </div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    <span class="keywordflow">if</span> (lon!=lon_old || lat!=lat_old) {</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        rock_previous2 = rock2;</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        surface_previous2 = surface2;</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        lat_old = lat;</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        lon_old = lon;</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;    </div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    } <span class="comment">//while</span></div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    </div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    <span class="keywordflow">return</span> foundit;</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;}<span class="comment">//WhereDoesItExitIceForward</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="keywordtype">double</span> IceModel::IceThickness(<span class="keywordtype">double</span> lon, <span class="keywordtype">double</span> lat) {</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;    <span class="comment">//This method returns the thickness of the ice in meters at a location specified by a latitude and longitude (in degrees).  A switch in the input file can be set to determine whether the Crust 2.0 model or the BEDMAP model is used to find the ice depth.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    <span class="keywordtype">double</span> ice_thickness=0;</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;ice_model is &quot; &lt;&lt; ice_model &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;icethkarray is &quot; &lt;&lt; icethkarray[(int)(lon/2)][(int)(lat/2)]*1000. &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;    <span class="keywordflow">if</span> (ice_model==1) {</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;    <span class="keywordtype">double</span> E=0;</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;    <span class="keywordtype">double</span> N=0;</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    LonLattoEN(lon,lat,E,N);</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;        <span class="keywordflow">if</span> (inHistBounds(E,N,h_ice_thickness))</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        {</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;        ice_thickness = h_ice_thickness.Interpolate(E,N); <span class="comment">//if this region has BEDMAP data, use it.</span></div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        }</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        {</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;        ice_thickness = icethkarray[(int)(lon/2)][(int)(lat/2)]*1000.; <span class="comment">//if the location given is not covered by BEDMAP, use Crust 2.0 data</span></div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;        }</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    } <span class="comment">//BEDMAP ice thickness</span></div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ice_model==0) {</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    ice_thickness = icethkarray[(int)(lon/2)][(int)(lat/2)]*1000.;</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;ilon, ilat are &quot; &lt;&lt; (int)(lon/2) &lt;&lt; &quot; &quot; &lt;&lt; (int)(lat/2) &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    } <span class="comment">//Crust 2.0 ice thickness</span></div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    </div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    <span class="keywordflow">return</span> ice_thickness;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;} <span class="comment">//method IceThickness</span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;<span class="keywordtype">double</span> IceModel::IceThickness(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos) {</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;    <span class="comment">//This method returns the thickness of the ice in meters at a location under a given position vector.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    </div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    <span class="keywordflow">return</span> IceThickness(pos.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>(),pos.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>());</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;} <span class="comment">//method IceThickness(position)</span></div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;<span class="keywordtype">double</span> IceModel::SurfaceAboveGeoid(<span class="keywordtype">double</span> lon, <span class="keywordtype">double</span> lat)  {</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;    <span class="comment">//This method returns the elevation above the geoid of the surface of the ice (or bare ground, if no ice is present) in meters, at a location specified by a latitude and longitude (in degrees).  In areas covered by water where no ice present, the method returns 0.  A switch in the input file can be set to determine whether the Crust 2.0 model or the BEDMAP model is used to find the ice depth.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;    <span class="comment">// lon must be 0 to 360</span></div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;    <span class="keywordtype">double</span> surface=0;</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    </div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    <span class="keywordflow">if</span> (ice_model==1) {</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;        <span class="keywordtype">double</span> E, N ; </div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;    LonLattoEN(lon,lat,E,N);</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;        <span class="keywordflow">if</span> (inHistBounds(E,N, h_ground_elevation))</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        {</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        surface = h_ground_elevation.Interpolate(E,N) + h_ice_thickness.Interpolate(E,N) + h_water_depth.Interpolate(E,N);</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;        }</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;        {</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        surface = surfacer[(int)(lon/2)][(int)(lat/2)]; <span class="comment">//If the position requested is outside the bounds of the BEDMAP data, use the Crust 2.0 data, regardless of the ice_model flag.</span></div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        }</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;    } <span class="comment">//Elevation of surface above geoid according to BEDMAP</span></div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ice_model==0) {</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    surface = surfacer[(int)(lon/2)][(int)(lat/2)];</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    } <span class="comment">//Elevation of surface above geoid according to Crust 2.0</span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    </div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    <span class="keywordflow">return</span> surface;</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;} <span class="comment">//method SurfaceAboveGeoid</span></div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="keywordtype">double</span> IceModel::SurfaceAboveGeoid(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos)  {</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    <span class="comment">//This method returns the elevation above the geoid of the surface of the ice (or bare ground, if no ice is present) in meters, at a location specified by a position vector.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    </div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    <span class="keywordflow">return</span> SurfaceAboveGeoid(pos.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>(),pos.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>());</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;} <span class="comment">//method SurfaceAboveGeoid(position)</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;<span class="keywordtype">double</span> IceModel::Surface(<span class="keywordtype">double</span> lon,<span class="keywordtype">double</span> lat)  {</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    <span class="keywordflow">return</span> (SurfaceAboveGeoid(lon,lat) + Geoid(lat)); <span class="comment">// distance from center of the earth to surface</span></div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;} <span class="comment">//Surface</span></div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;<span class="keywordtype">double</span> IceModel::Surface(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a>&amp; pos)  {</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    <span class="keywordflow">return</span> Surface(pos.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>(),pos.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>());</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;} <span class="comment">//Surface</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="keywordtype">double</span> IceModel::WaterDepth(<span class="keywordtype">double</span> lon, <span class="keywordtype">double</span> lat)  {</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    <span class="comment">//This method returns the depth of water beneath ice shelves in meters, at a location specified by a latitude and longitude (in degrees).  A switch in the input file can be set to determine whether the Crust 2.0 model or the BEDMAP model is used to find the ice depth.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    <span class="keywordtype">double</span> water_depth_value=0;</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    </div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    <span class="keywordflow">if</span> (ice_model==0) {</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    water_depth_value = waterthkarray[(int)(lon/2)][(int)(lat/2)]*1000;</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    } <span class="comment">//if(Crust 2.0)</span></div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ice_model==1) {</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        <span class="keywordtype">double</span> E, N; </div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    LonLattoEN(lon,lat,E,N);</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;        <span class="keywordflow">if</span> (inHistBounds(E,N,h_water_depth))</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;        {</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        water_depth_value = h_water_depth.Interpolate(E,N); </div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;        }</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;        water_depth_value = waterthkarray[(int)(lon/2)][(int)(lat/2)]*1000;</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    } <span class="comment">//else if(BEDMAP)</span></div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;    </div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;    <span class="keywordflow">return</span> water_depth_value;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;} <span class="comment">//method WaterDepth(longitude, latitude)</span></div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="keywordtype">double</span> IceModel::WaterDepth(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos) {</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;    <span class="comment">//This method returns the depth of water beneath ice shelves in meters, at a location specified by a position vector.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;    </div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    <span class="keywordflow">return</span> WaterDepth(pos.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>(),pos.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>());</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;} <span class="comment">//method WaterDepth(position)</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;<span class="keywordtype">int</span> IceModel::IceOnWater(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos) {</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;    <span class="keywordflow">if</span>(IceThickness(pos)&gt;0.&amp;&amp;WaterDepth(pos)&gt;0.)</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    </div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;}</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;<span class="keywordtype">int</span> IceModel::RossIceShelf(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos) {</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    <span class="keywordtype">int</span> ilon,ilat;</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    </div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    GetILonILat(pos,ilon,ilat);</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    </div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    <span class="keywordflow">if</span> ((ilat==2 &amp;&amp; ilon&gt;=5 &amp;&amp; ilon&lt;=14) ||</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    (ilat==3 &amp;&amp; (ilon&gt;=168 || ilon&lt;=14)) ||</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    (ilat==4 &amp;&amp; (ilon&gt;=168 || ilon&lt;=13)) ||</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    (ilat==5 &amp;&amp; (ilon&gt;=168 || ilon&lt;=14)))</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;}<span class="comment">//RossIceShelf</span></div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;<span class="keywordtype">int</span> IceModel::RossExcept(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos) {</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;    <span class="keywordtype">int</span> ilon,ilat;</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    GetILonILat(pos,ilon,ilat);</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;    <span class="keywordflow">if</span>(ilon&lt;=178&amp;&amp;ilon&gt;=174&amp;&amp;ilat&gt;=4&amp;&amp;ilat&lt;=5)</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;    <span class="keywordflow">else</span> </div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;}</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;<span class="keywordtype">int</span> IceModel::RonneIceShelf(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos) {</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    <span class="keywordtype">int</span> ilon,ilat;</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    </div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;    GetILonILat(pos,ilon,ilat);</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    </div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;    <span class="keywordflow">if</span> ((ilat==4 &amp;&amp; ilon&gt;=52 &amp;&amp; ilon&lt;=74) ||</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    (ilat==5 &amp;&amp; ilon&gt;=50 &amp;&amp; ilon&lt;=71) ||</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    (ilat==6 &amp;&amp; ilon&gt;=55 &amp;&amp; ilon&lt;=64))</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;    </div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;}<span class="comment">//RonneIceShelf</span></div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;<span class="keywordtype">int</span> IceModel::WestLand(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos) {</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;    <span class="keywordtype">double</span> lon = pos.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>() , lat = pos.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>();</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;    </div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;    <span class="keywordflow">if</span>((lat&gt;=4&amp;&amp;lat&lt;=26)&amp;&amp;((lon&gt;=0&amp;&amp;lon&lt;=180)||lon&gt;=336))</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;    </div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;}<span class="comment">//WestLand</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;<span class="keywordtype">double</span> IceModel::GetBalloonPositionWeight(<span class="keywordtype">int</span> ibnpos) {</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;  <span class="comment">//  cout &lt;&lt; &quot;ibnpos, volume_inhorizon, volume are &quot; &lt;&lt; ibnpos &lt;&lt; &quot; &quot; &lt;&lt; volume_inhorizon[ibnpos] &lt;&lt; &quot; &quot; &lt;&lt; volume &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    <span class="keywordflow">if</span> (volume_inhorizon[ibnpos]==0) {</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;      <span class="keywordflow">return</span> 0; <span class="comment">//we will be skipped anyway </span></div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;    }</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    </div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    <span class="keywordflow">return</span> volume/volume_inhorizon[ibnpos];</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;} <span class="comment">//GetBalloonPositionWeight</span></div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;<span class="keywordtype">int</span> IceModel::OutsideAntarctica(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos) {</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    <span class="keywordflow">return</span> (pos.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>() &gt;= COASTLINE);</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;} <span class="comment">//OutsideAntarctica(Position)</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<span class="keywordtype">int</span> IceModel::OutsideAntarctica(<span class="keywordtype">double</span> lat) {</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    <span class="keywordflow">return</span> (lat &gt;= COASTLINE);</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;} <span class="comment">//OutsideAntarctica(double lat)</span></div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;<span class="keywordtype">int</span> IceModel::AcceptableRfexit(<span class="keyword">const</span> <a class="code" href="../../d5/db2/class_vector.html">Vector</a> &amp;nsurf_rfexit,<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;rfexit,<span class="keyword">const</span> <a class="code" href="../../d5/db2/class_vector.html">Vector</a> &amp;n_exit2rx) {</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    </div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="comment">//Make sure there&#39;s actually ice where the ray leaves</span></div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    <span class="keywordflow">if</span> (rfexit.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>()&gt;COASTLINE || IceThickness(rfexit)&lt;0.0001) {</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    cout &lt;&lt; <span class="stringliteral">&quot;latitude is &quot;</span> &lt;&lt; rfexit.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>() &lt;&lt; <span class="stringliteral">&quot; compared to COASTLINE at &quot;</span> &lt;&lt; COASTLINE &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    cout &lt;&lt; <span class="stringliteral">&quot;ice thickness is &quot;</span> &lt;&lt; IceThickness(rfexit) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    </div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    </div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    <span class="keywordflow">if</span> (nsurf_rfexit*n_exit2rx&lt;0) {</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;dot product is &quot; &lt;&lt; nsurf_rfexit*n_exit2rx &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    </div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;} <span class="comment">//AcceptableRfexit</span></div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;<span class="keywordtype">double</span> IceModel::GetN(<span class="keywordtype">double</span> altitude) {</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;    <span class="comment">// these are Peter&#39;s fit parameters</span></div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;    <span class="keywordtype">double</span> a1=0.463251;</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    <span class="keywordtype">double</span> b1=0.0140157;</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;    <span class="keywordtype">double</span> n=0;</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;    </div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    <span class="keywordflow">if</span> (altitude &lt; FIRNDEPTH) </div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;    n=Signal::NICE;</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (altitude &gt;= FIRNDEPTH &amp;&amp; altitude &lt;=0 &amp;&amp; DEPTH_DEPENDENT_N) </div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;    <span class="comment">//    N_DEPTH=NFIRN-(4.6198+13.62*(altitude_int/1000.))*</span></div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    <span class="comment">//(altitude_int/1000.);   // Besson&#39;s equation for n(z)</span></div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    n=NFIRN+a1*(1.0-exp(b1*altitude));   <span class="comment">// Peter&#39;s equation for n(z)</span></div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (altitude &gt; 0)</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    cout&lt;&lt;<span class="stringliteral">&quot;Error!  N requested for position in air!\n&quot;</span>;</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!DEPTH_DEPENDENT_N)</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    n = NFIRN;</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    </div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    <span class="keywordflow">return</span> n;</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;} <span class="comment">//GetN(altitude)</span></div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;<span class="keywordtype">double</span> IceModel::GetN(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos) {</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    <span class="keywordflow">return</span> GetN(pos.Mag() - Surface(pos.<a class="code" href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Lon</a>(),pos.<a class="code" href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Lat</a>()));</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;} <span class="comment">//GetN(Position)</span></div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;<span class="keywordtype">double</span> IceModel::EffectiveAttenuationLength(<a class="code" href="../../db/d2b/class_settings.html">Settings</a> *settings1,<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp;pos,<span class="keyword">const</span> <span class="keywordtype">int</span> &amp;whichray) {</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    <span class="keywordtype">double</span> localmaxdepth = IceThickness(pos);</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    <span class="keywordtype">double</span> depth = Surface(pos) - pos.Mag();</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;depth is &quot; &lt;&lt; depth &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    <span class="keywordtype">int</span> depth_index=0;</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <span class="keywordtype">double</span> attenuation_length=0.0;</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    </div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    <span class="keywordflow">if</span>(WestLand(pos) &amp;&amp; !CONSTANTICETHICKNESS) </div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    {</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    depth_index=int(depth*419.9/localmaxdepth);<span class="comment">//use 420 m ice shelf attenuation length data as the standard, squeeze or stretch if localmaxdepth is longer or shorter than 420m.</span></div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;    <span class="keywordflow">if</span>(RossIceShelf(pos) || RonneIceShelf(pos)) </div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    {     </div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        <span class="keywordflow">if</span>(whichray==0)</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;        attenuation_length=l_shelfup[depth_index];</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichray==1)</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        attenuation_length=l_shelfdown[depth_index];</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;        cerr &lt;&lt; <span class="stringliteral">&quot; wrong attenuation length &quot;</span> &lt;&lt;endl;</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;        </div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        <span class="comment">//for sanity check</span></div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        <span class="keywordflow">if</span>((depth_index+0.5)!=d_shelfup[depth_index])</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        {</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;        cerr &lt;&lt; <span class="stringliteral">&quot;the index of the array l_iceshelfup is wrong!&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;        exit(1);</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;        }</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;    }</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;    <span class="keywordflow">else</span> <span class="comment">//in ice sheet of westland</span></div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;    {</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;        <span class="keywordflow">if</span>(whichray==0)</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        attenuation_length=l_westlandup[depth_index]; </div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichray==1)</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;        attenuation_length=l_westlanddown[depth_index];</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        cerr &lt;&lt; <span class="stringliteral">&quot; wrong attenuation length &quot;</span> &lt;&lt;endl;</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;        }</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    </div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    <span class="keywordflow">if</span>(settings1-&gt;MOOREBAY)<span class="comment">//if use Moore&#39;s Bay measured data for the west land</span></div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;        attenuation_length*=1.717557; <span class="comment">//about 450 m (field attenuation length) for one whole way when assuming -3dB for the power loss at the bottom</span></div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;    }</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    <span class="keywordflow">else</span> <span class="comment">//in east antarctica or constant ice thickness</span></div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    { </div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;    </div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    depth_index =int(depth*(2809.9/localmaxdepth));</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    </div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;    </div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    <span class="keywordflow">if</span>(whichray==0)</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        attenuation_length =l_sheetup[depth_index];</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(whichray==1)</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;        attenuation_length =l_sheetdown[depth_index];</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;        cerr &lt;&lt; <span class="stringliteral">&quot; wrong attenuation length &quot;</span> &lt;&lt;endl;</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;    } <span class="comment">//else</span></div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;    </div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    <span class="keywordflow">return</span> attenuation_length;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;} <span class="comment">//EffectiveAttenuationLengthUp</span></div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;<span class="keywordtype">double</span> IceModel::Area(<span class="keywordtype">double</span> latitude) {</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <span class="comment">//Returns the area of one square of the BEDMAP data at a given latitude. </span></div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    <span class="keywordtype">double</span> lat_rad = (90 - latitude) * RADDEG;</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;    </div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    <span class="keywordflow">return</span> (pow(cellSize* ((1 + sin(71*RADDEG)) / (1 + sin(lat_rad))),2));</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;} <span class="comment">//method Area</span></div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;<span class="keywordtype">void</span> IceModel::LonLattoEN(<span class="keywordtype">double</span> lon, <span class="keywordtype">double</span> lat,  <span class="keywordtype">double</span>&amp; E, <span class="keywordtype">double</span>&amp; N) {</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    <span class="comment">//takes as input a latitude and longitude (in degrees) and converts to indicies for BEDMAP matricies. Needs a location for the corner of the matrix, as not all the BEDMAP files cover the same area.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    </div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    </div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;    <span class="keywordtype">double</span> lon_rad = (lon - 180) * RADDEG; <span class="comment">//convert to radians, and shift origin to conventional spot</span></div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    <span class="keywordtype">double</span> lat_rad = (90 - lat) * RADDEG;</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    </div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    bedmap_R = scale_factor*bedmap_c_0 * pow(( (1 + eccentricity*sin(lat_rad)) / (1 - eccentricity*sin(lat_rad)) ),eccentricity/2) * tan((PI/4) - lat_rad/2);</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;    </div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    E = bedmap_R * sin(lon_rad);</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;    N = bedmap_R * cos(lon_rad);</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;} <span class="comment">//method LonLattoEN</span></div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;<span class="keywordtype">void</span> IceModel::ENtoLonLat(<span class="keywordtype">int</span> e_coord, <span class="keywordtype">int</span> n_coord, <span class="keywordtype">double</span> xLowerLeft, <span class="keywordtype">double</span> yLowerLeft, <span class="keywordtype">double</span>&amp; lon, <span class="keywordtype">double</span>&amp; lat)  {</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    <span class="comment">//Takes as input the indicies from a BEDMAP data set, and turns them into latitude and longitude coordinates.  Information on which data set (surface data, ice depth, water depth) is necessary, in the form of coordinates of a corner of the map.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    </div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;    <span class="keywordtype">double</span> isometric_lat=0;</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;    <span class="keywordtype">double</span> easting = xLowerLeft+(cellSize*(e_coord+0.5)); <span class="comment">//Add offset of 0.5 to get coordinates of middle of cell instead of edges.</span></div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    <span class="keywordtype">double</span> northing = -(yLowerLeft+(cellSize*(n_coord+0.5)));</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    </div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    <span class="comment">//  cout &lt;&lt; &quot;easting, northing are &quot; &lt;&lt; easting &lt;&lt; &quot; &quot; &lt;&lt; northing &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    </div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    <span class="comment">//first set longitude</span></div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    </div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    <span class="keywordflow">if</span> (northing!=0)</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;    lon = atan(easting/northing);</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;    lon = 90*RADDEG;</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;    </div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    <span class="comment">// this puts lon between -pi and pi</span></div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    <span class="keywordflow">if</span> (easting &gt; 0 &amp;&amp; lon &lt; 0) <span class="comment">//adjust sign of longitude</span></div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    lon += PI;</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (easting &lt; 0 &amp;&amp; lon &gt; 0)</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    lon -= PI;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (easting == 0 &amp;&amp; northing &lt; 0)</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;    lon += PI;</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    </div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    <span class="comment">//  now find latitude</span></div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    </div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;    <span class="keywordflow">if</span> (easting != 0)</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    bedmap_R = fabs(easting/sin(lon));</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (easting == 0 &amp;&amp; northing != 0)</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    bedmap_R = fabs(northing);</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;    <span class="keywordflow">else</span> {</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    lat = 0; <span class="comment">//at the pole, set lat=0 degrees</span></div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    lon = lon*DEGRAD; <span class="comment">// now put lon between 180 and 180 (only at pol)</span></div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;    } <span class="comment">//else</span></div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    </div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    isometric_lat = (PI/2) - 2*atan(bedmap_R/(scale_factor*bedmap_c_0));</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    </div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    lat = isometric_lat + bedmap_a_bar*sin(2*isometric_lat) + bedmap_b_bar*sin(4*isometric_lat) + bedmap_c_bar*sin(6*isometric_lat) + bedmap_d_bar*sin(8*isometric_lat);</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;    </div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;    lon = lon * DEGRAD + 180;  <span class="comment">//convert to degrees, shift 0 to line up with bin 0 of Crust 2.0</span></div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;    lat = 90 - lat*DEGRAD; <span class="comment">//convert to degrees, with 0 degrees at the south pole</span></div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;    </div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;    <span class="comment">//  if (lon&gt;160 &amp;&amp; lon&lt;165)</span></div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;e_coord, n_coord, easting, northing, lon are &quot; &lt;&lt; e_coord &lt;&lt; &quot; &quot; &lt;&lt; n_coord &lt;&lt; &quot; &quot; &lt;&lt; easting &lt;&lt; &quot; &quot; &lt;&lt; northing &lt;&lt; &quot; &quot; &lt;&lt; lon &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    </div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;} <span class="comment">//method ENtoLonLat</span></div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;<span class="keywordtype">void</span> IceModel::IceENtoLonLat(<span class="keywordtype">int</span> e, <span class="keywordtype">int</span> n, <span class="keywordtype">double</span>&amp; lon, <span class="keywordtype">double</span>&amp; lat) {</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    <span class="comment">//Converts indicies of the BEDMAP ice thickness matrix into longitude and latitude.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;    <span class="comment">// cout &lt;&lt; &quot;I&#39;m inside IceENtoLonLat.\n&quot;;</span></div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    ENtoLonLat(e,n,xLowerLeft_ice,yLowerLeft_ice,lon,lat);</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;}<span class="comment">//IceENtoLonLat</span></div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;<span class="keywordtype">void</span> IceModel::GroundENtoLonLat(<span class="keywordtype">int</span> e, <span class="keywordtype">int</span> n, <span class="keywordtype">double</span>&amp; lon, <span class="keywordtype">double</span>&amp; lat) {</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;    <span class="comment">//Converts indicies of the BEDMAP ground elevation matrix into longitude and latitude.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    ENtoLonLat(e,n,xLowerLeft_ground,yLowerLeft_ground,lon,lat);</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;}<span class="comment">//GroundENtoLonLat</span></div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;<span class="keywordtype">void</span> IceModel::WaterENtoLonLat(<span class="keywordtype">int</span> e, <span class="keywordtype">int</span> n, <span class="keywordtype">double</span>&amp; lon, <span class="keywordtype">double</span>&amp; lat) {</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="comment">//Converts indicies of the BEDMAP water depth matrix into longitude and latitude.  Code by Stephen Hoover.</span></div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    ENtoLonLat(e,n,xLowerLeft_water,yLowerLeft_water,lon,lat);</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;}<span class="comment">//WaterENtoLonLat</span></div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;<span class="keywordtype">void</span> IceModel::GetMAXHORIZON(<a class="code" href="../../d2/d24/class_balloon.html">Balloon</a> *bn1) {</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;    </div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;    <span class="keywordtype">double</span> altitude_inmeters=bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#aae0a6056476d43b3e44bc9ddf3d66afd">BN_ALTITUDE</a>;</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    <span class="keywordflow">if</span> (bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#aae0a6056476d43b3e44bc9ddf3d66afd">BN_ALTITUDE</a>==0.)</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a96a9419e73f0188979bdec29c4597d67">MAXHORIZON</a>=8.E5; <span class="comment">// if it is a standard flight then use a horizon of 800 km</span></div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a96a9419e73f0188979bdec29c4597d67">MAXHORIZON</a>=(sqrt((R_EARTH+altitude_inmeters)*(R_EARTH+altitude_inmeters)-R_EARTH*R_EARTH))*1.1; <span class="comment">// find distance from hrizon to balloon, increase it by 10% to be conservative.</span></div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    cout &lt;&lt; <span class="stringliteral">&quot;MAXHORIZON is &quot;</span> &lt;&lt; bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a96a9419e73f0188979bdec29c4597d67">MAXHORIZON</a> &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;}</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;<span class="keywordtype">void</span> IceModel::CreateHorizons(<a class="code" href="../../db/d2b/class_settings.html">Settings</a> *settings1,<a class="code" href="../../d2/d24/class_balloon.html">Balloon</a> *bn1,<span class="keywordtype">double</span> theta_bn,<span class="keywordtype">double</span> phi_bn,<span class="keywordtype">double</span> altitude_bn,ofstream &amp;foutput) {</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;    </div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    <span class="comment">// add up volume of ice within horizon of payload</span></div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;    <span class="comment">// goes a little beyond horizon.</span></div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    </div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    <span class="comment">// when we select a path in a circle at 80deg S latitude,</span></div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    <span class="comment">// vectors are binned in phi (longitude).</span></div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    </div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;    <span class="comment">// when we select the Anita-lite path, </span></div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    <span class="comment">// vectors are binned in time.</span></div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;    </div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    <span class="comment">//for (int i=0; i&lt;60;i++)</span></div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    <span class="comment">//cout&lt;&lt;&quot;area at lat &quot;&lt;&lt;(double)i/2&lt;&lt;&quot; is &quot;&lt;&lt;Area((double)i/2)&lt;&lt;endl;</span></div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;  </div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;    volume = 0.; <span class="comment">// initialize volume to zero</span></div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;    </div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;    <span class="keywordtype">double</span> total_area=0; <span class="comment">// initialize total area to zero</span></div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    <span class="keywordtype">int</span> NBALLOONPOSITIONS; <span class="comment">// number of balloon positions considered here</span></div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;    <span class="keywordflow">if</span> (bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==2) <span class="comment">// if anita-lite</span></div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;    NBALLOONPOSITIONS=(int)((<span class="keywordtype">double</span>)bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#aa11b7c8d8fca6acb9c5789a85974ad92">NPOINTS</a>/(double)bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a3a82e49e805b9070cf0684b519e20a6f">REDUCEBALLOONPOSITIONS</a>); <span class="comment">//only take 1/100 of the total balloon positions that we have because otherwise it&#39;s overkill.</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==6 || bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==7 || bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==8 || bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==9) {</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    NBALLOONPOSITIONS=(int)((<span class="keywordtype">double</span>)bn1-&gt;flightdatachain-&gt;GetEntries()/(double)bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a3a82e49e805b9070cf0684b519e20a6f">REDUCEBALLOONPOSITIONS</a>)+1;</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    }</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==1) <span class="comment">// for picking random point along 80 deg south</span></div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    NBALLOONPOSITIONS=NPHI; <span class="comment">// NPHI is the number of bins in phi for the visible ice in the horizon.  This is not the same as NLON, the number of bins in longitude for crust 2.0</span></div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;    <span class="keywordflow">else</span> <span class="comment">// includes fixed position (bn1-&gt;WHICHPATH=0)</span></div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;    NBALLOONPOSITIONS=1;</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;    </div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;    volume_inhorizon.resize(NBALLOONPOSITIONS); </div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;    maxvol_inhorizon.resize(NBALLOONPOSITIONS); </div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;    ilon_inhorizon.resize(NBALLOONPOSITIONS); </div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;    ilat_inhorizon.resize(NBALLOONPOSITIONS); </div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;    easting_inhorizon.resize(NBALLOONPOSITIONS); </div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;    northing_inhorizon.resize(NBALLOONPOSITIONS); </div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;   </div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;    <span class="keywordtype">double</span> phi_bn_temp=0; <span class="comment">//phi of balloon, temporary variable</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> r_bn_temp; <span class="comment">//position of balloon</span></div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;    <a class="code" href="../../d7/d3b/class_position.html">Position</a> r_bin; <span class="comment">// position of each bin</span></div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    </div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;    <span class="keywordtype">double</span> surface_elevation=0;</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;    <span class="keywordtype">double</span> local_ice_thickness=0;</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    <span class="keywordtype">double</span> lat=0;</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;    <span class="keywordtype">double</span> lon=0;</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;    <span class="comment">//double r=0; // r,theta and phi are temporary variables</span></div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;    <span class="keywordtype">double</span> theta=0;</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;    <span class="keywordtype">double</span> phi=0;</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;    <span class="keywordtype">int</span> volume_found=0;</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;    <span class="keywordtype">char</span> horizon_file[80];</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;    FILE *bedmap_horizons = 0;</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;    <span class="keywordtype">char</span> line[200];</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;    <span class="keywordtype">int</span> e_coord = 0;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;    <span class="keywordtype">int</span> n_coord = 0;</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;    </div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;    <span class="keywordflow">if</span> (bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==0) </div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;    {</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;      sprintf(horizon_file,<span class="stringliteral">&quot;bedmap_horizons_fixed_%g_%g_%g.dat&quot;</span>,bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a51eebf6b41e338b52dff8844dff87d56">BN_LATITUDE</a>, bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a51eebf6b41e338b52dff8844dff87d56">BN_LATITUDE</a>, bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#aae0a6056476d43b3e44bc9ddf3d66afd">BN_ALTITUDE</a>); </div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;    }</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;    {</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;      sprintf(horizon_file,<span class="stringliteral">&quot;bedmap_horizons_whichpath%i_weights%i.dat&quot;</span>,bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>,settings1-&gt;USEPOSITIONWEIGHTS);</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;    }</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;    </div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;    <span class="keywordflow">if</span> (ice_model==1 &amp;&amp; !settings1-&gt;WRITE_FILE) { <span class="comment">// for bedmap model, need to be able to read file</span></div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;    <span class="keywordflow">if</span>(!(bedmap_horizons = fopen(horizon_file, <span class="stringliteral">&quot;r&quot;</span>))) {</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;        printf(<span class="stringliteral">&quot;Error: unable to open %s.  Creating new file.\n&quot;</span>, horizon_file);</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;        settings1-&gt;WRITE_FILE=1;</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;    }<span class="comment">//if</span></div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;    <span class="keywordflow">if</span> (ice_model==1 &amp;&amp; settings1-&gt;WRITE_FILE) { <span class="comment">// for bedmap model, need to be able to write to file</span></div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;    <span class="keywordflow">if</span>(!(bedmap_horizons = fopen(horizon_file, <span class="stringliteral">&quot;w&quot;</span>))) {</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;        printf(<span class="stringliteral">&quot;Error: unable to open %s\n&quot;</span>, horizon_file);</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;        exit(1);</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;    }<span class="comment">//if</span></div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;    } <span class="comment">//else if</span></div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;    </div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;    <span class="keywordflow">if</span> (bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>!=2 &amp;&amp; bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>!=6) <span class="comment">// not anita and not anita-lite</span></div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;    lat=GetLat(theta_bn); <span class="comment">//get index of latitude, same for all balloon positions</span></div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;    </div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;    </div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;    </div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;NBALLOONPOSITIONS;i++) { <span class="comment">// loop over balloon positions</span></div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;    </div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;    maxvol_inhorizon[i]=-1.; <span class="comment">// volume of bin with the most ice in the horizon</span></div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;<span class="comment">//        double the_time = 0; </span></div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;    </div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;    <span class="keywordflow">if</span> (bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==2) { <span class="comment">// anita or anita-lite path</span></div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;        theta_bn=(90+bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a89cfc8cfa44410227aba08d70cbfc2bd">latitude_bn_anitalite</a>[i*bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a3a82e49e805b9070cf0684b519e20a6f">REDUCEBALLOONPOSITIONS</a>])*RADDEG; <span class="comment">//theta of the balloon wrt north pole</span></div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;        lat=GetLat(theta_bn); <span class="comment">// latitude  </span></div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;        phi_bn_temp=(-1*bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a4bf2d1dbe9b6c6b98f3d507fa7d1002e">longitude_bn_anitalite</a>[i*bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a3a82e49e805b9070cf0684b519e20a6f">REDUCEBALLOONPOSITIONS</a>]+90.); <span class="comment">//phi of the balloon, with 0 at +x and going counter clockwise looking down from the south pole</span></div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;        <span class="keywordflow">if</span> (phi_bn_temp&lt;0) <span class="comment">//correct phi_bn if it&#39;s negative</span></div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        phi_bn_temp+=360.;</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;        phi_bn_temp*=RADDEG;<span class="comment">// turn it into radians</span></div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;        </div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;        </div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;        altitude_bn=bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a356923e58f8c56224ff6995537146491">altitude_bn_anitalite</a>[i*bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a3a82e49e805b9070cf0684b519e20a6f">REDUCEBALLOONPOSITIONS</a>]*12.*CMINCH/100.; <span class="comment">// get the altitude for this balloon posistion (ANITA-lite had values in feet)</span></div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;        </div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;    } <span class="comment">// end if anita-lite</span></div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;    </div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;       </div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    </div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==6 || bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==7 || bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==8 || bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==9) {</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;        </div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;        bn1-&gt;flightdatachain-&gt;GetEvent(i*bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a3a82e49e805b9070cf0684b519e20a6f">REDUCEBALLOONPOSITIONS</a>);</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;<span class="comment">//      the_time = bn1-&gt;realTime_flightdata_temp; //??!? </span></div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;        </div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;        theta_bn=(90+(double)bn1-&gt;flatitude)*RADDEG; <span class="comment">//theta of the balloon wrt north pole</span></div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;        lat=GetLat(theta_bn); <span class="comment">// latitude  </span></div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;        phi_bn_temp=(-1*(double)bn1-&gt;flongitude+90.); <span class="comment">//phi of the balloon, with 0 at +x and going counter clockwise looking down from the south pole</span></div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;        <span class="keywordflow">if</span> (phi_bn_temp&lt;0) <span class="comment">//correct phi_bn if it&#39;s negative</span></div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;        phi_bn_temp+=360.;</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;        phi_bn_temp*=RADDEG;<span class="comment">// turn it into radians</span></div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;        </div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;        altitude_bn=(double)bn1-&gt;faltitude; <span class="comment">// for anita, altitude in is meters</span></div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;        </div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    } <span class="comment">// end if anita or anita-lite</span></div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">WHICHPATH</a>==1) <span class="comment">// for picking random position along 80 deg south</span></div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;        phi_bn_temp=dGetPhi(i); <span class="comment">//get phi of the balloon just based on the balloon positions.  Remember nballoonpositions runs from 0 to 179 here.</span></div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    <span class="comment">// the output of dGetPhi is in radians and runs from -pi/2 to 3*pi/2 relative to </span></div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;    <span class="keywordflow">else</span> <span class="comment">// includes bn1-&gt;WHICHPATH=0 </span></div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;        phi_bn_temp=phi_bn;</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    </div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;    <span class="comment">// altitude_bn has already been set in SetDefaultBalloonPosition </span></div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    <span class="comment">// same for theta_bn</span></div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;    <span class="comment">// lat set above</span></div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    </div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;    lon=GetLon(phi_bn_temp); <span class="comment">//get longitude for this phi position</span></div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;    <span class="comment">// lon goes from 0 (at -180 longitude) to 360 (at 180 longitude)</span></div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;    </div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;    <span class="comment">// position of balloon</span></div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;    surface_elevation = this-&gt;Surface(lon,lat); <span class="comment">// distance from center of the earth to surface at this lon and lat</span></div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;    r_bn_temp = <a class="code" href="../../d5/db2/class_vector.html">Vector</a>(sin(theta_bn)*cos(phi_bn_temp)*(surface_elevation+altitude_bn),</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;               sin(theta_bn)*sin(phi_bn_temp)*(surface_elevation+altitude_bn),</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;               cos(theta_bn)*(surface_elevation+altitude_bn)); <span class="comment">// vector from center of the earth to balloon</span></div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;    </div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    <span class="comment">// cout &lt;&lt; &quot;MAXHORIZON is &quot; &lt;&lt; MAXHORIZON &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;    </div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;    </div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;    <span class="keywordflow">if</span> (ice_model==0) { <span class="comment">// Crust 2.0</span></div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;NLON;j++) { <span class="comment">// loop over bins in longitude</span></div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0;k&lt;ILAT_COASTLINE;k++) { <span class="comment">// loop over bins in latitude</span></div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;            </div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;            <span class="comment">// get position of each bin</span></div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;            r_bin = <a class="code" href="../../d5/db2/class_vector.html">Vector</a>(sin(dGetTheta(k))*cos(dGetPhi(j))*(geoid[k]+surfacer[j][k]),</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;                   sin(dGetTheta(k))*sin(dGetPhi(j))*(geoid[k]+surfacer[j][k]),</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;                   cos(dGetTheta(k))*(geoid[k]+surfacer[j][k])); <span class="comment">// vector from center of the earth to the surface of this bin</span></div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;            </div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;            </div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;            <span class="keywordflow">if</span> (!volume_found) </div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;            volume += icethkarray[j][k]*1000*area[k]; <span class="comment">// add this to the total volume of ice in antarctica</span></div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;            <span class="keywordflow">if</span> (!volume_found &amp;&amp; icethkarray[j][k] &gt; 0)</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;            total_area += area[k]; <span class="comment">// add this to the total area of ice in antarctica</span></div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;            </div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;            <span class="comment">// if the bin is within the maximum horizon of the balloon or if we don&#39;t care</span></div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;            <span class="comment">//r=(geoid[k]+surfacer[j][k]);</span></div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;            <span class="comment">//phi=dGetPhi(j);</span></div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;            <span class="comment">//theta=dGetTheta(k);</span></div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;            </div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;            <span class="comment">//    cout &lt;&lt; &quot;USEWEIGHTS is &quot; &lt;&lt; USEWEIGHTS &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;            <span class="keywordflow">if</span> ((settings1-&gt;USEPOSITIONWEIGHTS &amp;&amp; r_bin.<a class="code" href="../../d7/d3b/class_position.html#a68bbe0fdc40d3d380f633a88735f212e">Distance</a>(r_bn_temp)&lt;bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a96a9419e73f0188979bdec29c4597d67">MAXHORIZON</a>)</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;            || !settings1-&gt;USEPOSITIONWEIGHTS) {</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;            <span class="comment">// then put this latitude and longitude in vector</span></div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;            </div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;            </div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;            ilat_inhorizon[i].push_back(k); </div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;            ilon_inhorizon[i].push_back(j);</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;            <span class="comment">// add up volume in horizon</span></div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;            </div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;            </div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;            volume_inhorizon[i]+=icethkarray[j][k]*1000*area[k];</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;            </div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;            </div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;            <span class="comment">// finding which bin in horizon has maximum volume</span></div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;            <span class="keywordflow">if</span> (icethkarray[j][k]*1000*area[k]&gt;maxvol_inhorizon[i]) {</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;                maxvol_inhorizon[i]=icethkarray[j][k]*1000.*area[k];</div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;            }</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;            } <span class="comment">//end if (distance &lt; 800 km)</span></div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;            </div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;            </div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;        } <span class="comment">//end for (k loop)</span></div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;        } <span class="comment">//end for (j loop)   </span></div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;        </div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;        <span class="comment">//      cout &lt;&lt; &quot;i, volume_inhorizon are &quot; &lt;&lt; i &lt;&lt; &quot; &quot; &lt;&lt; volume_inhorizon[i] &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;        </div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;        <span class="comment">// ifi the balloon is too close to the ice, it will think there aren&#39;t any</span></div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;        <span class="comment">// bins in the horizon, so force it the include the ones just below the balloon</span></div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;        <span class="keywordtype">int</span> ilat_bn,ilon_bn;</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;        GetILonILat(r_bn_temp,ilon_bn,ilat_bn); <span class="comment">// find which longitude and latitude the balloon is above</span></div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;        </div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;        <span class="keywordflow">if</span> (ilat_inhorizon[i].size()==0 || ilon_inhorizon[i].size()==0) {</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;        maxvol_inhorizon[i]=icethkarray[ilon_bn][ilat_bn]*1000.*area[ilat_bn]; <span class="comment">// need to give it a maximum volume for a bin in horizon </span></div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;        volume_inhorizon[i]=icethkarray[ilon_bn][ilat_bn]*1000.*area[ilat_bn]; <span class="comment">// and a total volume for the horizon</span></div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;        }</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;        </div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;        <span class="keywordflow">if</span> (ilat_inhorizon[i].size()==0) <span class="comment">// for the ith balloon position, if it didn&#39;t find a latitude bin in horizon</span></div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;        ilat_inhorizon[i].push_back(ilat_bn); <span class="comment">// force it to be the one below the balloon       </span></div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;        </div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;        <span class="keywordflow">if</span> (ilon_inhorizon[i].size()==0) <span class="comment">// for the ith balloon position, if it didn&#39;t find a longitude bin in horizon</span></div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;        ilon_inhorizon[i].push_back(ilon_bn); <span class="comment">// force it to be the one below the balloon</span></div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;        </div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;        </div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;        </div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;    } <span class="comment">//end if (ice_model==0) Crust 2.0</span></div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;    </div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ice_model==1 &amp;&amp; !settings1-&gt;WRITE_FILE) { <span class="comment">// for bedmap model</span></div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;        fgets(line,200,bedmap_horizons);</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;        <span class="keywordflow">while</span>(line[0] != <span class="charliteral">&#39;X&#39;</span>) {</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;        e_coord = atoi(strtok(line,<span class="stringliteral">&quot;,&quot;</span>));</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;        n_coord = atoi(strtok(NULL,<span class="stringliteral">&quot;,&quot;</span>));</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;        easting_inhorizon[i].push_back(e_coord);</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;        northing_inhorizon[i].push_back(n_coord);</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;        fgets(line,200,bedmap_horizons);</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;        } <span class="comment">//while there are more eastings and northings</span></div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;        strtok(line,<span class="stringliteral">&quot;,&quot;</span>);</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;        volume_inhorizon[i] = atof(strtok(NULL,<span class="stringliteral">&quot;,&quot;</span>)); <span class="comment">// volume in the horizon</span></div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;        maxvol_inhorizon[i] = atof(strtok(NULL,<span class="stringliteral">&quot;,&quot;</span>));</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;        </div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;        <span class="keywordflow">if</span> (!volume_found) {</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;        total_area = atof(fgets(line,200,bedmap_horizons)); <span class="comment">// total area on the continent</span></div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;        volume = atof(fgets(line,200,bedmap_horizons)); <span class="comment">// total volume on the continent</span></div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;        } <span class="comment">//if</span></div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;    } <span class="comment">//end if (ice_model==1) &amp;&amp; !settings1-&gt;WRITE_FILE</span></div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;    </div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ice_model==1 &amp;&amp; settings1-&gt;WRITE_FILE) { <span class="comment">//for BEDMAP model, look through all easting and northing coordinates in the groundbed map (our smallest).  Output what we find to a file for later use.</span></div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;        </div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n_coord=0;n_coord&lt;nRows_ground;n_coord++) {</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> e_coord=0;e_coord&lt;nCols_ground;e_coord++) {</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;            </div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;            GroundENtoLonLat(e_coord,n_coord,lon,lat);</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;            </div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;            theta = lat * RADDEG;</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;            phi=LongtoPhi_0is180thMeridian(lon);</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;            </div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;            surface_elevation = this-&gt;Surface(lon,lat);</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;            local_ice_thickness = this-&gt;IceThickness(lon,lat);</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;            </div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;            <span class="comment">// get position of each bin</span></div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;            r_bin = <a class="code" href="../../d5/db2/class_vector.html">Vector</a>(sin(theta)*cos(phi)*surface_elevation,</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;                   sin(theta)*sin(phi)*surface_elevation,</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;                   cos(theta)*surface_elevation);</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;            </div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;            <span class="keywordflow">if</span> (!volume_found)</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;            volume += local_ice_thickness*Area(lat);</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;            <span class="keywordflow">if</span> (!volume_found &amp;&amp; local_ice_thickness &gt; 5)</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;            total_area += Area(lat);</div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;            <span class="keywordflow">if</span> ((settings1-&gt;USEPOSITIONWEIGHTS &amp;&amp; r_bn_temp.<a class="code" href="../../d7/d3b/class_position.html#a68bbe0fdc40d3d380f633a88735f212e">Distance</a>(r_bin)&lt;bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a96a9419e73f0188979bdec29c4597d67">MAXHORIZON</a>) || !settings1-&gt;USEPOSITIONWEIGHTS) {</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;            fprintf(bedmap_horizons,<span class="stringliteral">&quot;%i,%i,\n&quot;</span>,e_coord,n_coord);</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;            <span class="comment">// then put this latitude and longitude in vector</span></div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;            easting_inhorizon[i].push_back(e_coord);</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;            northing_inhorizon[i].push_back(n_coord);</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;            <span class="comment">// add up volume in horizon</span></div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;            </div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;            GroundENtoLonLat(e_coord,n_coord,lon,lat);</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;            </div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;            </div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;            volume_inhorizon[i]+=local_ice_thickness*Area(lat);</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;            </div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;            <span class="comment">// finding which bin in horizon has maximum volumey</span></div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;            <span class="keywordflow">if</span> (local_ice_thickness*Area(lat)&gt;maxvol_inhorizon[i]) {</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;              maxvol_inhorizon[i]=local_ice_thickness*Area(lat);</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;            }</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;            } <span class="comment">//end if (distance &lt; 800 km &amp; ice present)</span></div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;        } <span class="comment">//end for (e_coord loop)</span></div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;        } <span class="comment">//end for (n_coord loop)</span></div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;        </div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;        fprintf(bedmap_horizons,<span class="stringliteral">&quot;X,%f,%f,\n&quot;</span>,volume_inhorizon[i],maxvol_inhorizon[i]);</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;        <span class="keywordflow">if</span> (!volume_found) {</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;        fprintf(bedmap_horizons,<span class="stringliteral">&quot;%f\n&quot;</span>,total_area);</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;        fprintf(bedmap_horizons,<span class="stringliteral">&quot;%f\n&quot;</span>,volume);</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;        } <span class="comment">//if</span></div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;        </div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;    } <span class="comment">//end if (ice_model==1) &amp;&amp; settings1-&gt;WRITE_FILE</span></div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    </div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;    <span class="keywordflow">if</span> (!volume_found) {</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;        cout&lt;&lt;<span class="stringliteral">&quot;Total surface area covered with ice (in m^2) is : &quot;</span>&lt;&lt;total_area&lt;&lt;endl;</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;        volume_found=1;</div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;    } <span class="comment">//if</span></div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;    } <span class="comment">//end loop over balloon positions</span></div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;    </div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;    <span class="keywordflow">if</span> (bedmap_horizons) </div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;      fclose(bedmap_horizons); </div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;    <span class="comment">// finding average volume in horizon over all balloon positions.</span></div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;    volume_inhorizon_average=0;</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;    </div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;NBALLOONPOSITIONS;i++) {</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    volume_inhorizon_average+=volume_inhorizon[i];</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;    </div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;    } <span class="comment">//for</span></div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;    volume_inhorizon_average/=(double)NBALLOONPOSITIONS;</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;    </div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;Total volume of ice in Antarctica with this ice model (m^3): &quot; &lt;&lt; volume &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;    <span class="comment">//cout &lt;&lt; &quot;Average volume of ice within a horizon is &quot; &lt;&lt; volume_inhorizon_average &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    </div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;    foutput &lt;&lt; <span class="stringliteral">&quot;Average volume of ice within a horizon is &quot;</span> &lt;&lt; volume_inhorizon_average &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;    </div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;    foutput &lt;&lt; <span class="stringliteral">&quot;Average thickness of ice within horizon, averages over balloon positions &quot;</span> &lt;&lt; volume_inhorizon_average/PI/pow(bn1-&gt;<a class="code" href="../../d2/d24/class_balloon.html#a96a9419e73f0188979bdec29c4597d67">MAXHORIZON</a>,2) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;} <span class="comment">//method CreateHorizons </span></div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;<span class="keywordtype">void</span> IceModel::ReadIceThickness() {</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;    <span class="comment">//Reads the BEDMAP ice thickness data.  Assumes the file is in directory &quot;data&quot;.  Code by Ryan Nichol, added to Monte Carlo by Stephen Hoover</span></div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;    </div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;  ifstream IceThicknessFile((ICEMC_DATA_DIR+<span class="stringliteral">&quot;/icethic.asc&quot;</span>).c_str());</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;    <span class="keywordflow">if</span>(!IceThicknessFile) {</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    cerr &lt;&lt; <span class="stringliteral">&quot;Couldn&#39;t open: $ICEMC_DATA_DIR/icethic.asc&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;    exit(1);</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;    }</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;    </div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;    cout&lt;&lt;<span class="stringliteral">&quot;Reading in BEDMAP data on ice thickness.\n&quot;</span>;</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;    </div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;    <span class="keywordtype">string</span> tempBuf1;</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    <span class="keywordtype">string</span> tempBuf2;</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;    <span class="keywordtype">string</span> tempBuf3;</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    <span class="keywordtype">string</span> tempBuf4;</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    <span class="keywordtype">string</span> tempBuf5;</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;    <span class="keywordtype">string</span> tempBuf6;</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;    <span class="keywordtype">int</span> temp1,temp2,temp3,temp4,temp5,temp6;</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;    </div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;    IceThicknessFile &gt;&gt; tempBuf1 &gt;&gt; temp1 &gt;&gt; tempBuf2 &gt;&gt; temp2 </div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;    &gt;&gt; tempBuf3 &gt;&gt; temp3 &gt;&gt; tempBuf4 &gt;&gt; temp4 </div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;    &gt;&gt; tempBuf5 &gt;&gt; temp5 &gt;&gt; tempBuf6 &gt;&gt; temp6;</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;    </div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;    <span class="keywordflow">if</span>(tempBuf1 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;ncols&quot;</span>)) {</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;    nCols_ice=temp1;</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;    }</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;    <span class="keywordflow">if</span>(tempBuf2 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;nrows&quot;</span>)) {</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;    nRows_ice=temp2;</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;    }</div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;    <span class="keywordflow">if</span>(tempBuf3 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;xllcorner&quot;</span>)) {</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;    xLowerLeft_ice=temp3;</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;    }</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;    <span class="keywordflow">if</span>(tempBuf4 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;yllcorner&quot;</span>)) {</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;    yLowerLeft_ice=temp4;</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;    }</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;    <span class="keywordflow">if</span>(tempBuf5 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;cellsize&quot;</span>)) {</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;    cellSize=temp5;</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;    }</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;    <span class="keywordflow">if</span>(tempBuf6 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;NODATA_value&quot;</span>)) {</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;    NODATA=temp6;</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;    }</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;    <span class="comment">//cout&lt;&lt;&quot;nCols_ice, nRows_ice &quot;&lt;&lt;nCols_ice&lt;&lt;&quot; , &quot;&lt;&lt;nRows_ice&lt;&lt;endl;</span></div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;    <span class="comment">//cout&lt;&lt;&quot;xLL_ice, yLL_ice, cellsize &quot;&lt;&lt;xLowerLeft_ice&lt;&lt;&quot; , &quot;&lt;&lt;yLowerLeft_ice&lt;&lt;&quot; , &quot;&lt;&lt;cellSize&lt;&lt;endl&lt;&lt;endl;</span></div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;    </div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;    assert(nRows_ice == 1000 &amp;&amp; nCols_ice==1200); </div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    h_ice_thickness.SetBins(nCols_ice, xLowerLeft_ice, xLowerLeft_ice + nCols_ice*cellSize, </div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;                           nRows_ice, yLowerLeft_ice, yLowerLeft_ice+nRows_ice*cellSize);</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;    <span class="keywordtype">double</span> theValue;</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;    volume=0.;</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;    ice_area=0.;</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;    max_icevol_perbin=0.;</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;    max_icethk_perbin=0.;</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;    <span class="keywordtype">double</span> lon_tmp,lat_tmp;</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> rowNum=0;rowNum&lt;nRows_ice;rowNum++) {</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> colNum=0;colNum&lt;nCols_ice;colNum++) {</div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;        IceENtoLonLat(colNum,rowNum,lon_tmp,lat_tmp);</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;        IceThicknessFile &gt;&gt; theValue;</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;        <span class="keywordflow">if</span>(theValue==NODATA)</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;        theValue=0; <span class="comment">//Set ice depth to 0 where we have no data.</span></div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;            <span class="comment">//note that the histogram has a backwards indexing on rows since it&#39;s defined in a different order</span></div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;        h_ice_thickness.SetBinContent(1+colNum, nRows_ice-rowNum, theValue); </div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;        volume+=theValue*Area(lat_tmp);</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;        <span class="keywordflow">if</span> (theValue&gt;0)</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;        ice_area+=Area(lat_tmp);</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;        <span class="keywordflow">if</span> (theValue*Area(lat_tmp)&gt;max_icevol_perbin)</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;        max_icevol_perbin=theValue*Area(lat_tmp);</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;        <span class="keywordflow">if</span> (theValue&gt;max_icethk_perbin)</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;        max_icethk_perbin=theValue;</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    }<span class="comment">//for</span></div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;    }<span class="comment">//for</span></div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    </div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;    IceThicknessFile.close();</div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;} <span class="comment">//method ReadIceThickness</span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;<span class="keywordtype">void</span> IceModel::ReadGroundBed() {</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;    <span class="comment">//Reads the BEDMAP data on the elevation of the ground beneath the ice.  If there is water beneath the ice, the ground elevation is given the value 0.  Assumes the file is in directory &quot;data&quot;.  Code by Ryan Nichol, added to Monte Carlo by Stephen Hoover</span></div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;  ifstream GroundBedFile((ICEMC_DATA_DIR+<span class="stringliteral">&quot;/groundbed.asc&quot;</span>).c_str());</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;    <span class="keywordflow">if</span>(!GroundBedFile) {</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;    cerr &lt;&lt; <span class="stringliteral">&quot;Couldn&#39;t open: ICEMC_DATA_DIR/groundbed.asc&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;    exit(1);</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;    }</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;    </div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;    cout&lt;&lt;<span class="stringliteral">&quot;Reading in BEDMAP data on elevation of ground.\n&quot;</span>;</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;    </div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;    <span class="keywordtype">string</span> tempBuf1;</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;    <span class="keywordtype">string</span> tempBuf2;</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;    <span class="keywordtype">string</span> tempBuf3;</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;    <span class="keywordtype">string</span> tempBuf4;</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;    <span class="keywordtype">string</span> tempBuf5;</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;    <span class="keywordtype">string</span> tempBuf6;</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;    <span class="keywordtype">int</span> temp1,temp2,temp3,temp4,temp5,temp6;</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;    </div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;    GroundBedFile &gt;&gt; tempBuf1 &gt;&gt; temp1 &gt;&gt; tempBuf2 &gt;&gt; temp2 </div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;    &gt;&gt; tempBuf3 &gt;&gt; temp3 &gt;&gt; tempBuf4 &gt;&gt; temp4 </div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;    &gt;&gt; tempBuf5 &gt;&gt; temp5 &gt;&gt; tempBuf6 &gt;&gt; temp6;</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;    </div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;    <span class="keywordflow">if</span>(tempBuf1 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;ncols&quot;</span>)) {</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;    nCols_ground=temp1;</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;    }</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;    <span class="keywordflow">if</span>(tempBuf2 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;nrows&quot;</span>)) {</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;    nRows_ground=temp2;</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;    }</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;    <span class="keywordflow">if</span>(tempBuf3 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;xllcorner&quot;</span>)) {</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    xLowerLeft_ground=temp3;</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    }</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;    <span class="keywordflow">if</span>(tempBuf4 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;yllcorner&quot;</span>)) {</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;    yLowerLeft_ground=temp4;</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;    }</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;    <span class="keywordflow">if</span>(tempBuf5 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;cellsize&quot;</span>)) {</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    cellSize=temp5;</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;    }</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;    <span class="keywordflow">if</span>(tempBuf6 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;NODATA_value&quot;</span>)) {</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;    NODATA=temp6;</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;    }</div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;    assert(nRows_ground == 869 &amp;&amp; nCols_ground==1068); </div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;    </div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;    h_ground_elevation.SetBins(nCols_ground, xLowerLeft_ground, xLowerLeft_ground + nCols_ground*cellSize, </div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;                               nRows_ground, yLowerLeft_ground, yLowerLeft_ground + nRows_ground*cellSize);</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;    <span class="comment">//cout&lt;&lt;&quot;nCols_ground, nRows_ground &quot;&lt;&lt;nCols_ground&lt;&lt;&quot; , &quot;&lt;&lt;nRows_ground&lt;&lt;endl;</span></div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;    <span class="comment">//cout&lt;&lt;&quot;xLL_ground, yLL_ground, cellsize &quot;&lt;&lt;xLowerLeft_ground&lt;&lt;&quot; , &quot;&lt;&lt;yLowerLeft_ground&lt;&lt;&quot; , &quot;&lt;&lt;cellSize&lt;&lt;endl&lt;&lt;endl;</span></div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;    </div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;    <span class="keywordtype">double</span> theValue;</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> rowNum=0;rowNum&lt;nRows_ground;rowNum++) {</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> colNum=0;colNum&lt;nCols_ground;colNum++) {</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;        GroundBedFile &gt;&gt; theValue;</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;        </div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;        <span class="keywordflow">if</span>(theValue==NODATA)</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;        theValue=0; <span class="comment">//Set elevation to 0 where we have no data.</span></div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;        h_ground_elevation.SetBinContent(colNum+1,nRows_ground-rowNum, <span class="keywordtype">double</span>(theValue));</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;        <span class="comment">//if (theValue != -96 &amp;&amp; theValue != 0)</span></div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;        <span class="comment">//cout&lt;&lt;&quot;ground_elevation: &quot;&lt;&lt;theValue&lt;&lt;endl;</span></div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    }<span class="comment">//for</span></div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;    }<span class="comment">//for</span></div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;    </div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;    GroundBedFile.close();</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;} <span class="comment">//method ReadGroundBed</span></div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;<span class="keywordtype">void</span> IceModel::ReadWaterDepth() {</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;    <span class="comment">//Reads BEDMAP data on the depth of water beneath the ice.  Where no water is present, the value 0 is entered.  Assumes the file is in directory &quot;data&quot;.  Code by Ryan Nichol, added to Monte Carlo by Stephen Hoover</span></div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;  ifstream WaterDepthFile((ICEMC_DATA_DIR+<span class="stringliteral">&quot;/water.asc&quot;</span>).c_str());</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;    <span class="keywordflow">if</span>(!WaterDepthFile) {</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;    cerr &lt;&lt; <span class="stringliteral">&quot;Couldn&#39;t open: ICEMC_DATA_DIR/water.asc&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;    exit(1);</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;    }</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;    </div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;    cout&lt;&lt;<span class="stringliteral">&quot;Reading in BEDMAP data on water depth.\n&quot;</span>;</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    </div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;    <span class="keywordtype">string</span> tempBuf1;</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;    <span class="keywordtype">string</span> tempBuf2;</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;    <span class="keywordtype">string</span> tempBuf3;</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;    <span class="keywordtype">string</span> tempBuf4;</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    <span class="keywordtype">string</span> tempBuf5;</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;    <span class="keywordtype">string</span> tempBuf6;</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;    <span class="keywordtype">int</span> temp1,temp2,temp3,temp4,temp5,temp6;</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;    </div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    WaterDepthFile &gt;&gt; tempBuf1 &gt;&gt; temp1 &gt;&gt; tempBuf2 &gt;&gt; temp2 </div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;    &gt;&gt; tempBuf3 &gt;&gt; temp3 &gt;&gt; tempBuf4 &gt;&gt; temp4 </div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;    &gt;&gt; tempBuf5 &gt;&gt; temp5 &gt;&gt; tempBuf6 &gt;&gt; temp6;</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;    </div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;    <span class="keywordflow">if</span>(tempBuf1 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;ncols&quot;</span>)) {</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;    nCols_water=temp1;</div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;    }</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;    <span class="keywordflow">if</span>(tempBuf2 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;nrows&quot;</span>)) {</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;    nRows_water=temp2;</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;    }</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;    <span class="keywordflow">if</span>(tempBuf3 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;xllcorner&quot;</span>)) {</div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;    xLowerLeft_water=temp3;</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;    }</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;    <span class="keywordflow">if</span>(tempBuf4 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;yllcorner&quot;</span>)) {</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;    yLowerLeft_water=temp4;</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;    }</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;    <span class="keywordflow">if</span>(tempBuf5 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;cellsize&quot;</span>)) {</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;    cellSize=temp5;</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;    }</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;    <span class="keywordflow">if</span>(tempBuf6 == <span class="keywordtype">string</span>(<span class="stringliteral">&quot;NODATA_value&quot;</span>)) {</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;    NODATA=temp6;</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;    }</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;    </div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;    <span class="comment">//cout&lt;&lt;&quot;nCols_water, nRows_water &quot;&lt;&lt;nCols_water&lt;&lt;&quot; , &quot;&lt;&lt;nRows_water&lt;&lt;endl;</span></div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;    <span class="comment">//cout&lt;&lt;&quot;xLL_water, yLL_water, cellsize &quot;&lt;&lt;xLowerLeft_water&lt;&lt;&quot; , &quot;&lt;&lt;yLowerLeft_water&lt;&lt;&quot; , &quot;&lt;&lt;cellSize&lt;&lt;endl&lt;&lt;endl;</span></div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;    </div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;    assert(nRows_water == 1000 &amp;&amp; nCols_water==1200); </div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;    h_water_depth.SetBins(nCols_water, xLowerLeft_water, xLowerLeft_water + nCols_water*cellSize, </div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;                          nRows_water, yLowerLeft_water, yLowerLeft_water+nRows_water*cellSize);</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    <span class="keywordtype">double</span> theValue;</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> rowNum=0;rowNum&lt;nRows_water;rowNum++) {</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> colNum=0;colNum&lt;nCols_water;colNum++) {</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;        WaterDepthFile &gt;&gt; theValue;</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;        </div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;        <span class="keywordflow">if</span>(theValue==NODATA)</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;        theValue=0; <span class="comment">//Set depth to 0 where we have no data.</span></div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;        h_water_depth.SetBinContent(1+colNum,nRows_water-rowNum, <span class="keywordtype">double</span>(theValue));</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;    }<span class="comment">//for</span></div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;    }<span class="comment">//for</span></div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;    </div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;    WaterDepthFile.close();</div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;} <span class="comment">//method ReadWaterDepth</span></div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;<span class="comment">//Methods related to the 2D cartesian surfaces</span></div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;<span class="keywordtype">void</span> IceModel::CreateCartesianTopAndBottom(<span class="keywordtype">int</span> resolution, <span class="keywordtype">bool</span> force)  </div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;{</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;  TString fname;</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;  <span class="keywordflow">if</span> (resolution == cart_resolution) </div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;  {</div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;    return ;</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;  } </div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;  cart_resolution = resolution; </div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;  <span class="keywordflow">if</span> (cart_ice_file) <span class="keyword">delete</span> cart_ice_file; </div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;  fname.Form(<span class="stringliteral">&quot;%s/cartesian_icemodel_%d_%d.root&quot;</span>, getenv(<span class="stringliteral">&quot;ICEMC_SRC_DIR&quot;</span>)?: <span class="stringliteral">&quot;.&quot;</span>, ice_model ,  resolution); </div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;  TDirectory * olddir = gDirectory; </div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;  <span class="comment">//check if it exists</span></div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;  <span class="keywordflow">if</span> (!force) </div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;  {</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;    cart_ice_file = <span class="keyword">new</span> TFile(fname); </div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;    <span class="keywordflow">if</span> (!cart_ice_file-&gt;IsOpen())</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;    {</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;      <span class="keyword">delete</span> cart_ice_file; </div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;    }</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;    <span class="keywordflow">else</span> </div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;    {</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;      cart_ice_top = (TH2*) cart_ice_file-&gt;Get(<span class="stringliteral">&quot;top&quot;</span>);</div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;      cart_ice_bot = (TH2*) cart_ice_file-&gt;Get(<span class="stringliteral">&quot;bot&quot;</span>);</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;</div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;      <span class="keywordflow">if</span> (!cart_ice_top || !cart_ice_bot) </div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;      {</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;        <span class="keyword">delete</span> cart_ice_file; </div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;      }</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;      {</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;        olddir-&gt;cd();</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;        <span class="keywordflow">return</span>; </div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;      }</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;    }</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;  }</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;  <span class="comment">//if we got this far, we don&#39;t already have it </span></div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;  cart_ice_file = <span class="keyword">new</span> TFile(fname,<span class="stringliteral">&quot;RECREATE&quot;</span>); </div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;  <span class="comment">//the bounds will roughly be +/- REARTH /2,so we&#39;ll convert that to our resolution</span></div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;  printf(<span class="stringliteral">&quot;Creating new cartesian ice file at %s...\n&quot;</span>, cart_ice_file-&gt;GetName()); </div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;  <span class="keywordtype">double</span> bound = ceil(6371000/2/resolution)*resolution; </div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;  <span class="keywordtype">int</span> nbins = (2*bound)/resolution; </div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;  </div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;  TString hname; </div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;  hname.Form(<span class="stringliteral">&quot;icetop_%d_%d&quot;</span>, ice_model, resolution); </div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;  TString htitle; </div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;  htitle.Form(<span class="stringliteral">&quot;Ice Top (model=%d, res=%d m)&quot;</span>, ice_model, resolution); </div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;  cart_ice_top = <span class="keyword">new</span> TH2D(hname.Data(), htitle.Data(), nbins,-bound,bound,nbins,-bound,bound);</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;  hname.Form(<span class="stringliteral">&quot;icebot_%d_%d&quot;</span>, ice_model, resolution); </div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;  htitle.Form(<span class="stringliteral">&quot;Ice Bottom (model=%d, res=%d m)&quot;</span>, ice_model, resolution); </div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;  cart_ice_bot= <span class="keyword">new</span> TH2D(hname.Data(), htitle.Data(), nbins,-bound,bound,nbins,-bound,bound);</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;  <span class="comment">// auxiliary hists</span></div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;  hname.Form(<span class="stringliteral">&quot;ice_bot_r_%d_%d&quot;</span>,ice_model, resolution);</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;  htitle.Form(<span class="stringliteral">&quot;Ice Bottom (r) (model=%d, res=%d m)&quot;</span>, ice_model, resolution); </div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;  TH2 * r_bot= <span class="keyword">new</span> TH2D(hname.Data(), htitle.Data(), nbins,-bound,bound,nbins,-bound,bound);</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;  hname.Form(<span class="stringliteral">&quot;ice_top_r_%d_%d&quot;</span>,ice_model, resolution);</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;  htitle.Form(<span class="stringliteral">&quot;Ice top (r) (model=%d, res=%d m)&quot;</span>, ice_model, resolution); </div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;  TH2 * r_top= <span class="keyword">new</span> TH2D(hname.Data(), htitle.Data(), nbins,-bound,bound,nbins,-bound,bound);</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;  hname.Form(<span class="stringliteral">&quot;ice_bot_alt_%d_%d&quot;</span>,ice_model, resolution);</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;  htitle.Form(<span class="stringliteral">&quot;Ice Bottom (alt) (model=%d, res=%d m)&quot;</span>, ice_model, resolution); </div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;  TH2 * alt_bot= <span class="keyword">new</span> TH2D(hname.Data(), htitle.Data(), nbins,-bound,bound,nbins,-bound,bound);</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;</div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;  hname.Form(<span class="stringliteral">&quot;ice_top_alt_%d_%d&quot;</span>,ice_model, resolution);</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;  htitle.Form(<span class="stringliteral">&quot;Ice top (alt) (model=%d, res=%d m)&quot;</span>, ice_model, resolution); </div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;  TH2 * alt_top= <span class="keyword">new</span> TH2D(hname.Data(), htitle.Data(), nbins,-bound,bound,nbins,-bound,bound);</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt;= nbins; j++) </div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;  {</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;    <span class="keywordtype">double</span> y = cart_ice_top-&gt;GetYaxis()-&gt;GetBinCenter(j);</div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt;= nbins; i++) </div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;    {</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;      <span class="keywordtype">double</span> x = cart_ice_top-&gt;GetXaxis()-&gt;GetBinCenter(i);</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;      <span class="keywordtype">double</span> r2 = x*x+y*y; </div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">double</span> a = 6378137;</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">double</span> a2 = a*a; </div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;      <span class="keywordflow">if</span> (r2 &gt; a2) <span class="keywordflow">continue</span>; </div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">double</span> b = 6356752.314245; ;</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">double</span> b2 = b*b; </div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;      <span class="keywordtype">double</span> z_geoid = sqrt((1-r2/a2)*b2); </div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;      <a class="code" href="../../d7/d3b/class_position.html">Position</a> p(<a class="code" href="../../d5/db2/class_vector.html">Vector</a>(x,y,z_geoid)); </div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;      <span class="keywordtype">double</span> lon = p.Lon(); </div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;      <span class="keywordtype">double</span> lat = p.Lat(); </div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;      <span class="keywordtype">double</span> ice_depth = IceThickness(lon,lat); </div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;      <span class="keywordflow">if</span> (ice_depth) </div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;      {</div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;        <span class="keywordtype">double</span> surface_above_geoid = SurfaceAboveGeoid(lon,lat); </div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;        <span class="keywordtype">double</span> geoid = Geoid(lat); </div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;        <span class="keywordtype">double</span> surface = surface_above_geoid+geoid; </div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;        <a class="code" href="../../d7/d3b/class_position.html">Position</a> top(lon,lat,surface);</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;        <a class="code" href="../../d7/d3b/class_position.html">Position</a> bot(lon,lat,surface-ice_depth);</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;        cart_ice_top-&gt;SetBinContent(i,j,top.Z()); </div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;        cart_ice_bot-&gt;SetBinContent(i,j,bot.Z()); </div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;        r_top-&gt;SetBinContent(i,j,surface); </div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;        r_bot-&gt;SetBinContent(i,j,surface-ice_depth); </div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;        alt_top-&gt;SetBinContent(i,j,surface_above_geoid); </div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;        alt_bot-&gt;SetBinContent(i,j,surface_above_geoid-ice_depth); </div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;      }</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;    }</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;  }</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;  cart_ice_top-&gt;Write(<span class="stringliteral">&quot;top&quot;</span>);</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;  cart_ice_bot-&gt;Write(<span class="stringliteral">&quot;bot&quot;</span>);</div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;  r_top-&gt;Write(<span class="stringliteral">&quot;r_top&quot;</span>);</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;  r_bot-&gt;Write(<span class="stringliteral">&quot;r_bot&quot;</span>);</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;  alt_top-&gt;Write(<span class="stringliteral">&quot;alt_top&quot;</span>);</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;  alt_bot-&gt;Write(<span class="stringliteral">&quot;alt_bot&quot;</span>);</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;  cart_ice_file-&gt;Flush(); </div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;  printf(<span class="stringliteral">&quot;...Done!\n&quot;</span>); </div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;  olddir-&gt;cd();</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;}</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;</div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;<span class="keywordtype">bool</span> IceModel::CartesianIsInIce(<span class="keywordtype">double</span> x,<span class="keywordtype">double</span> y, <span class="keywordtype">double</span> z) </div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;{</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;  <span class="keyword">const</span> TH2 * htop = GetCartesianTop();</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;  <span class="keywordflow">if</span> (z &gt; cart_max_z) <span class="keywordflow">return</span> <span class="keyword">false</span>; </div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;  <span class="keywordflow">if</span> (z &lt; cart_min_z) <span class="keywordflow">return</span> <span class="keyword">false</span>; </div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;  <span class="keywordflow">if</span> (x &lt; htop-&gt;GetXaxis()-&gt;GetXmin()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;  <span class="keywordflow">if</span> (x &gt; htop-&gt;GetXaxis()-&gt;GetXmax()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;  <span class="keywordflow">if</span> (y &lt; htop-&gt;GetYaxis()-&gt;GetXmin()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;  <span class="keywordflow">if</span> (y &gt; htop-&gt;GetYaxis()-&gt;GetXmax()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;</div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;  <span class="keywordtype">double</span> top = ((TH2*)htop)-&gt;Interpolate(x,y); </div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;  <span class="keywordflow">if</span> (!top) <span class="keywordflow">return</span> <span class="keyword">false</span>; </div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;  <span class="keywordflow">return</span> z &lt; top &amp;&amp; z &gt; ((TH2*)GetCartesianBottom())-&gt;Interpolate(x,y);</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;}</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;<span class="keywordtype">int</span> IceModel::GetIceIntersectionsCartesian(<span class="keyword">const</span> <a class="code" href="../../d7/d3b/class_position.html">Position</a> &amp; posnu, <span class="keyword">const</span> <a class="code" href="../../d5/db2/class_vector.html">Vector</a> &amp; nnu_in, </div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;                                           std::vector&lt;std::pair&lt;double,double&gt; &gt; &amp; intersection_points, </div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;                                           <span class="keywordtype">double</span> start_step, <span class="keywordtype">int</span> map_resolution) </div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;{</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;  <span class="keywordflow">if</span> (map_resolution!= cart_resolution) CreateCartesianTopAndBottom(map_resolution); </div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;  <span class="keywordflow">if</span> (cart_max_z == -1)</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;  {</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;    cart_max_z =  GetCartesianTop()-&gt;GetMaximum();</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;    cart_min_z = cart_max_z; </div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;    <span class="keyword">const</span> TH2 * hbot = GetCartesianBottom(); </div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt;= hbot-&gt;GetNbinsY(); j++) </div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;    {</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt;= hbot-&gt;GetNbinsX(); i++) </div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;      {</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;        <span class="keywordtype">double</span> val = hbot-&gt;GetBinContent(i,j); </div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;        <span class="keywordflow">if</span> (val &gt; 0 &amp;&amp; val &lt; cart_min_z) cart_min_z = val; </div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;      }</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;    }</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;  }</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;  std::vector&lt;double&gt; boundaries; </div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;  <span class="comment">//is our start point in the ice? </span></div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;  <span class="keywordtype">bool</span> start_in_ice = CartesianIsInIce(posnu.X(), posnu.Y(), posnu.Z()); </div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;  <a class="code" href="../../d5/db2/class_vector.html">Vector</a> nnu = nnu_in.Unit(); </div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;  <span class="comment">//let&#39;s start at the position and go both ways</span></div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = -1; dir &lt;=1 ; dir+=2) </div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;  {</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;    <a class="code" href="../../d5/db2/class_vector.html">Vector</a> x = posnu; </div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;    <span class="keywordtype">bool</span> was_in_ice = start_in_ice; </div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;    <span class="comment">// go until we are way to far away from the Earth to matter</span></div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;    </div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    <span class="keywordtype">double</span> displacement = 0;</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;    <span class="keywordtype">bool</span> jumped = <span class="keyword">false</span>;</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;    <span class="keywordtype">bool</span> just_jumped = <span class="keyword">false</span>;</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;    <span class="keywordflow">while</span> (<span class="keyword">true</span>) <span class="comment">//this is mean Earth radius + 5 km. </span></div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;    {</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;<span class="comment">//      printf(&quot;%g  -&gt;  %g,%g,%g\n&quot;, displacement, x.X(),x.Y(), x.Z()); </span></div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;      displacement += start_step*dir; </div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;      x = posnu + displacement*nnu; </div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;      <span class="keywordtype">double</span> mag2 = x.X()*x.X() + x.Y()*x.Y() + x.Z()*x.Z(); </div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160; <span class="comment">//     printf(&quot; %g\n&quot;, sqrt(mag2)); </span></div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;      <span class="keywordflow">if</span> (mag2 &gt; (7000e3*7000e3))</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;      {</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;        printf(<span class="stringliteral">&quot;wtf:  [%g,%g,%g], %g\n&quot;</span>, x.X(), x.Y(), x.Z(), mag2); </div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;      }</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;      <span class="keywordflow">if</span> (mag2 &gt; (6365e3*6365e3))</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;      {</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;        <span class="keywordflow">break</span>; </div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;      }</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;      <span class="comment">//jump to the other side of the world if we dip down too much! </span></div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;      <span class="keywordflow">if</span> (mag2 &lt; (6355.5e3*6355.5e3) &amp;&amp; !jumped &amp;&amp; !was_in_ice) </div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;      {</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;       <span class="comment">// printf(&quot;Trying to go to other side of the earth! start displacement: %g, mag: %g\n&quot;, displacement,sqrt(mag2));</span></div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;        <span class="keywordtype">double</span> ds[2]; </div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;        GeoidIntersection(x,dir*nnu, 0,0,-1000,ds); </div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;        <span class="comment">//now figure out which is on the opposite side of the Earth from where we are...  since we&#39;re using our current position and direction it should be the positive one! </span></div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;        displacement = (ds[0] &gt; 0 ? ds[0] : ds[1])*dir; </div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;        <span class="comment">//printf(&quot;End displacement: %g\n&quot;, displacement); </span></div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;        jumped = <span class="keyword">true</span>; </div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;        just_jumped = <span class="keyword">true</span>; </div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;        <span class="keywordflow">continue</span>; </div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;      }</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;      </div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;      <span class="keywordtype">bool</span> is_in_ice = CartesianIsInIce(x.X(),x.Y(),x.Z()); </div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;      <span class="comment">//this is no bueno...we won&#39;t find the right boundary in this case!  </span></div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;      <span class="comment">// let&#39;s back up 500 m from where we were at the start of this iteration</span></div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;      <span class="keywordflow">if</span> (just_jumped &amp;&amp; is_in_ice) </div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;      {</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;        displacement -= dir*(500+start_step); </div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;        <span class="keywordflow">continue</span>; </div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;      }</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;      just_jumped = <span class="keyword">false</span>; </div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;      <span class="keywordflow">if</span> (was_in_ice!=is_in_ice) </div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;      {</div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;        <span class="comment">//binary search for the boundary to 1 m resolution</span></div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;        <a class="code" href="../../d5/db2/class_vector.html">Vector</a> xsearch = x; </div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;        <span class="keywordtype">double</span> step = -start_step*dir/2; </div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;        <span class="keywordtype">bool</span> search_was_in_ice = is_in_ice; </div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;        <span class="keywordtype">double</span> boundary_displacement = displacement; </div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;        <span class="keywordflow">while</span> (fabs(step) &gt; 1) </div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;        {</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;          boundary_displacement+=step;</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;          xsearch = posnu + boundary_displacement * nnu; </div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;          <span class="keywordtype">bool</span> search_is_in_ice = CartesianIsInIce(xsearch.X(),xsearch.Y(),xsearch.Z()); </div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;          step*=0.5; </div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;          <span class="keywordflow">if</span> (search_is_in_ice!=search_was_in_ice) step*=-1; </div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;          search_was_in_ice = search_is_in_ice; </div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;        }</div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;        <span class="comment">//we found a boundary! (if there is more than one boundary within this segment... we probably picked a random one. Oh well. </span></div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;        boundaries.push_back(boundary_displacement); </div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;      }</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;      was_in_ice = is_in_ice; </div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;    }</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;  }</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;  std::sort(boundaries.begin(), boundaries.end()); </div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;  <span class="keywordflow">if</span> (boundaries.size() % 2) </div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;  {</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;Uh oh, have an odd number of boundaries (%lu) . That means there&#39;s a bug...\n&quot;</span>, boundaries.size()); </div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; boundaries.size(); i++) printf(<span class="stringliteral">&quot; %g &quot;</span>, boundaries[i]); </div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;    printf(<span class="stringliteral">&quot;\n&quot;</span>); </div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;    assert(0);</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;    <span class="keywordflow">return</span> -1; </div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;  }</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; boundaries.size()/2; i++)</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;  {</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;    intersection_points.push_back(std::pair&lt;double,double&gt;(boundaries[2*i], boundaries[2*i+1])); </div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;  }</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;  <span class="keywordflow">return</span> boundaries.size()/2; </div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;}</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;</div><div class="ttc" id="class_balloon_html_a81c68a6d332881cf4759a4bcca7dc48c"><div class="ttname"><a href="../../d2/d24/class_balloon.html#a81c68a6d332881cf4759a4bcca7dc48c">Balloon::WHICHPATH</a></div><div class="ttdeci">int WHICHPATH</div><div class="ttdoc">0=fixed balloon position,1=randomized,2=ANITA-lite GPS data,3=banana plot </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/balloon_8hh_source.html#l00057">balloon.hh:57</a></div></div>
<div class="ttc" id="class_position_html_a68bbe0fdc40d3d380f633a88735f212e"><div class="ttname"><a href="../../d7/d3b/class_position.html#a68bbe0fdc40d3d380f633a88735f212e">Position::Distance</a></div><div class="ttdeci">double Distance(const Position &amp;second) const </div><div class="ttdoc">Returns chord distance (direct distance between two vectors) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dd0/position_8cc_source.html#l00037">position.cc:37</a></div></div>
<div class="ttc" id="class_balloon_html_a96a9419e73f0188979bdec29c4597d67"><div class="ttname"><a href="../../d2/d24/class_balloon.html#a96a9419e73f0188979bdec29c4597d67">Balloon::MAXHORIZON</a></div><div class="ttdeci">double MAXHORIZON</div><div class="ttdoc">pick the interaction within this distance from the balloon so that it is within the horizon ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/balloon_8hh_source.html#l00078">balloon.hh:78</a></div></div>
<div class="ttc" id="class_balloon_html_a3a82e49e805b9070cf0684b519e20a6f"><div class="ttname"><a href="../../d2/d24/class_balloon.html#a3a82e49e805b9070cf0684b519e20a6f">Balloon::REDUCEBALLOONPOSITIONS</a></div><div class="ttdeci">int REDUCEBALLOONPOSITIONS</div><div class="ttdoc">only take every 100th entry in the flight data file </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/balloon_8hh_source.html#l00056">balloon.hh:56</a></div></div>
<div class="ttc" id="namespace_environment_variable_html_a064f876067320b15e34beb8c29c8ffdc"><div class="ttname"><a href="../../d4/d7f/namespace_environment_variable.html#a064f876067320b15e34beb8c29c8ffdc">EnvironmentVariable::ICEMC_SRC_DIR</a></div><div class="ttdeci">const char * ICEMC_SRC_DIR()</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/dd9/_environment_variable_8cc_source.html#l00056">EnvironmentVariable.cc:56</a></div></div>
<div class="ttc" id="class_balloon_html_a356923e58f8c56224ff6995537146491"><div class="ttname"><a href="../../d2/d24/class_balloon.html#a356923e58f8c56224ff6995537146491">Balloon::altitude_bn_anitalite</a></div><div class="ttdeci">double altitude_bn_anitalite[100000]</div><div class="ttdoc">same for altitude </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/balloon_8hh_source.html#l00085">balloon.hh:85</a></div></div>
<div class="ttc" id="class_balloon_html_a51eebf6b41e338b52dff8844dff87d56"><div class="ttname"><a href="../../d2/d24/class_balloon.html#a51eebf6b41e338b52dff8844dff87d56">Balloon::BN_LATITUDE</a></div><div class="ttdeci">double BN_LATITUDE</div><div class="ttdoc">balloon latitude for fixed balloon location </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/balloon_8hh_source.html#l00089">balloon.hh:89</a></div></div>
<div class="ttc" id="class_interaction_html_a3ef3decda6e004ad20f541949a948ae0"><div class="ttname"><a href="../../d3/d8e/class_interaction.html#a3ef3decda6e004ad20f541949a948ae0">Interaction::weight_nu</a></div><div class="ttdeci">double weight_nu</div><div class="ttdoc">Weight for neutrino that survives to posnu. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/dea/_primaries_8h_source.html#l00191">Primaries.h:191</a></div></div>
<div class="ttc" id="structicemodel__debug_html"><div class="ttname"><a href="../../d8/d3a/structicemodel__debug.html">icemodel_debug</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/dee/icemodel_8hh_source.html#l00042">icemodel.hh:42</a></div></div>
<div class="ttc" id="class_position_html_a33b137a138fa73850401f9c95be7b9fa"><div class="ttname"><a href="../../d7/d3b/class_position.html#a33b137a138fa73850401f9c95be7b9fa">Position::Lat</a></div><div class="ttdeci">double Lat() const </div><div class="ttdoc">Returns latitude, where the +z direction is at 0 latitude. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dd0/position_8cc_source.html#l00047">position.cc:47</a></div></div>
<div class="ttc" id="class_settings_html"><div class="ttname"><a href="../../db/d2b/class_settings.html">Settings</a></div><div class="ttdoc">Reads in and stores input settings for the run. </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d4a/_settings_8h_source.html#l00037">Settings.h:37</a></div></div>
<div class="ttc" id="class_balloon_html_aa11b7c8d8fca6acb9c5789a85974ad92"><div class="ttname"><a href="../../d2/d24/class_balloon.html#aa11b7c8d8fca6acb9c5789a85974ad92">Balloon::NPOINTS</a></div><div class="ttdeci">int NPOINTS</div><div class="ttdoc">number of GPS positions we&amp;#39;re picking from. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/balloon_8hh_source.html#l00080">balloon.hh:80</a></div></div>
<div class="ttc" id="class_balloon_html_aae0a6056476d43b3e44bc9ddf3d66afd"><div class="ttname"><a href="../../d2/d24/class_balloon.html#aae0a6056476d43b3e44bc9ddf3d66afd">Balloon::BN_ALTITUDE</a></div><div class="ttdeci">double BN_ALTITUDE</div><div class="ttdoc">pick balloon altitude </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/balloon_8hh_source.html#l00059">balloon.hh:59</a></div></div>
<div class="ttc" id="class_position_html"><div class="ttname"><a href="../../d7/d3b/class_position.html">Position</a></div><div class="ttdoc">This class is a 3-vector that represents a position on the Earth&amp;#39;s surface. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d18/position_8hh_source.html#l00026">position.hh:26</a></div></div>
<div class="ttc" id="class_interaction_html"><div class="ttname"><a href="../../d3/d8e/class_interaction.html">Interaction</a></div><div class="ttdoc">Stores everything about a particular neutrino interaction. Interaction. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/dea/_primaries_8h_source.html#l00135">Primaries.h:135</a></div></div>
<div class="ttc" id="class_balloon_html_a4bf2d1dbe9b6c6b98f3d507fa7d1002e"><div class="ttname"><a href="../../d2/d24/class_balloon.html#a4bf2d1dbe9b6c6b98f3d507fa7d1002e">Balloon::longitude_bn_anitalite</a></div><div class="ttdeci">double longitude_bn_anitalite[100000]</div><div class="ttdoc">same for longitude </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/balloon_8hh_source.html#l00084">balloon.hh:84</a></div></div>
<div class="ttc" id="class_interaction_html_a46d7e538970790ac8d4eff1f9024af93"><div class="ttname"><a href="../../d3/d8e/class_interaction.html#a46d7e538970790ac8d4eff1f9024af93">Interaction::total_kgm2</a></div><div class="ttdeci">double total_kgm2</div><div class="ttdoc">number of earth layers traversed </div><div class="ttdef"><b>Definition:</b> <a href="../../df/dea/_primaries_8h_source.html#l00206">Primaries.h:206</a></div></div>
<div class="ttc" id="class_interaction_html_a8e3ba9835075f10bf3b1aa136a828434"><div class="ttname"><a href="../../d3/d8e/class_interaction.html#a8e3ba9835075f10bf3b1aa136a828434">Interaction::r_in</a></div><div class="ttdeci">Position r_in</div><div class="ttdoc">position where neutrino enters the earth </div><div class="ttdef"><b>Definition:</b> <a href="../../df/dea/_primaries_8h_source.html#l00194">Primaries.h:194</a></div></div>
<div class="ttc" id="class_earth_model_html"><div class="ttname"><a href="../../d1/d3b/class_earth_model.html">EarthModel</a></div><div class="ttdoc">Shape of the earth, ice thicknesses, profiles of earth layers, densities, neutrino absorption...</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d26/earthmodel_8hh_source.html#l00040">earthmodel.hh:40</a></div></div>
<div class="ttc" id="class_interaction_html_abcc316da4319289b2c4517df75c002e4"><div class="ttname"><a href="../../d3/d8e/class_interaction.html#abcc316da4319289b2c4517df75c002e4">Interaction::weight_nu_prob</a></div><div class="ttdeci">double weight_nu_prob</div><div class="ttdoc">Weight for neutrino that survives to posnu and interacts in the ice. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/dea/_primaries_8h_source.html#l00192">Primaries.h:192</a></div></div>
<div class="ttc" id="class_interaction_html_a360281505aa31a40d78a09d7c7b70000"><div class="ttname"><a href="../../d3/d8e/class_interaction.html#a360281505aa31a40d78a09d7c7b70000">Interaction::PickAnyDirection</a></div><div class="ttdeci">void PickAnyDirection()</div><div class="ttdoc">Constructor. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/dd4/_primaries_8cc_source.html#l00277">Primaries.cc:277</a></div></div>
<div class="ttc" id="class_balloon_html_a89cfc8cfa44410227aba08d70cbfc2bd"><div class="ttname"><a href="../../d2/d24/class_balloon.html#a89cfc8cfa44410227aba08d70cbfc2bd">Balloon::latitude_bn_anitalite</a></div><div class="ttdeci">double latitude_bn_anitalite[100000]</div><div class="ttdoc">latitude at times along flightpath, equally distributed among gps data. This is filled with anita or ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/balloon_8hh_source.html#l00083">balloon.hh:83</a></div></div>
<div class="ttc" id="class_balloon_html"><div class="ttname"><a href="../../d2/d24/class_balloon.html">Balloon</a></div><div class="ttdoc">Handles everything related to balloon positions, payload orientation over the course of a flight...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d3b/balloon_8hh_source.html#l00030">balloon.hh:30</a></div></div>
<div class="ttc" id="class_interaction_html_a8d9fcec0d43f38c83f692ed19026fed8"><div class="ttname"><a href="../../d3/d8e/class_interaction.html#a8d9fcec0d43f38c83f692ed19026fed8">Interaction::nuexitice</a></div><div class="ttdeci">Position nuexitice</div><div class="ttdoc">place where neutrino would have left the ice </div><div class="ttdef"><b>Definition:</b> <a href="../../df/dea/_primaries_8h_source.html#l00197">Primaries.h:197</a></div></div>
<div class="ttc" id="class_vector_html"><div class="ttname"><a href="../../d5/db2/class_vector.html">Vector</a></div><div class="ttdoc">This class represents a three-vector. Operators are overloaded to provide for the familiar operations...</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d61/vector_8hh_source.html#l00027">vector.hh:27</a></div></div>
<div class="ttc" id="class_interaction_html_a8d6ead334dc4c35bfd23a25237e212af"><div class="ttname"><a href="../../d3/d8e/class_interaction.html#a8d6ead334dc4c35bfd23a25237e212af">Interaction::r_enterice</a></div><div class="ttdeci">Position r_enterice</div><div class="ttdoc">position where neutrino enters the ice </div><div class="ttdef"><b>Definition:</b> <a href="../../df/dea/_primaries_8h_source.html#l00195">Primaries.h:195</a></div></div>
<div class="ttc" id="class_position_html_a736146228c802ee9b3f0953349c4410a"><div class="ttname"><a href="../../d7/d3b/class_position.html#a736146228c802ee9b3f0953349c4410a">Position::Lon</a></div><div class="ttdeci">double Lon() const </div><div class="ttdoc">Returns longitude. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dd0/position_8cc_source.html#l00051">position.cc:51</a></div></div>
<div class="ttc" id="class_ice_model_html"><div class="ttname"><a href="../../de/d63/class_ice_model.html">IceModel</a></div><div class="ttdoc">Ice thicknesses and water depth. </div><div class="ttdef"><b>Definition:</b> <a href="../../d2/dee/icemodel_8hh_source.html#l00103">icemodel.hh:103</a></div></div>
<div class="ttc" id="class_interaction_html_a2f87c301b70f44c40b2fa43951ad55d5"><div class="ttname"><a href="../../d3/d8e/class_interaction.html#a2f87c301b70f44c40b2fa43951ad55d5">Interaction::nnu</a></div><div class="ttdeci">Vector nnu</div><div class="ttdoc">direction of neutrino (+z in south pole direction) </div><div class="ttdef"><b>Definition:</b> <a href="../../df/dea/_primaries_8h_source.html#l00187">Primaries.h:187</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Apr 5 2021 19:55:41 for ANITA Software by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
